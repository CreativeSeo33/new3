{% extends 'catalog/base.html.twig' %}

{% block title %}Личный кабинет — {{ parent() }}{% endblock %}

{% block catalog_body %}
  <div class="container mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold text-gray-900 mb-6">Личный кабинет</h1>

    <nav class="tabs tabs-bordered tabs-lg overflow-x-auto" aria-label="Tabs" role="tablist" aria-orientation="horizontal">
      <button type="button" class="tab active-tab:tab-active active w-full" id="tabs-basic-filled-item-1" data-tab="#tabs-basic-filled-1" aria-controls="tabs-basic-filled-1" role="tab" aria-selected="true">
        Ваши заказы
      </button>
      <button type="button" class="tab active-tab:tab-active w-full" id="tabs-basic-filled-item-2" data-tab="#tabs-basic-filled-2" aria-controls="tabs-basic-filled-2" role="tab" aria-selected="false">
        Данные аккаунта
      </button>
    </nav>

    <div class="mt-3.5">
      <div id="tabs-basic-filled-1" role="tabpanel" aria-labelledby="tabs-basic-filled-item-1">
        {% if orders is defined and orders|length > 0 %}
          <div class="space-y-6">
            {% for o in orders %}
              <div class="p-4 border rounded">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                  <div class="text-lg font-medium">Заказ <span class="font-mono">#{{ o.orderId }}</span></div>
                  <div class="flex items-center gap-3 text-sm text-gray-700">
                    <div>
                      <span class="text-gray-500">Статус:</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100">{{ statusNameById[o.status]|default(o.status) }}</span>
                    </div>
                    <div><span class="text-gray-500">Дата:</span> {{ o.dateAdded ? o.dateAdded|date('d.m.Y') : '—' }}</div>
                  </div>
                </div>

                {% if o.products|length > 0 %}
                  <div class="space-y-3" data-testid="order-items">
                    {% set goodsSubtotal = 0 %}
                    {% for p in o.products %}
                      {% set unit = (p.salePrice is not null and p.salePrice > 0) ? p.salePrice : (p.price ?? 0) %}
                      {% set row = unit * (p.quantity ?? 0) %}
                      {% set goodsSubtotal = goodsSubtotal + row %}
                      <div class="flex gap-3 items-start border-b pb-3" data-testid="order-item">
                        <div class="w-16 h-16 shrink-0">
                          {% set prod = (productMap[p.productId] ?? null) %}
                          {% if prod and prod.image|length > 0 %}
                            {% set firstImage = prod.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
                            {% if firstImage %}
                              {% set raw = firstImage.imageUrl %}
                              {% if raw starts with '/media/cache/' %}
                                {% set imgSrc = raw %}
                              {% else %}
                                {% set rel = raw|replace({'/img/':''})|trim('/') %}
                                {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
                              {% endif %}
                              <img src="{{ imgSrc }}" alt="{{ p.productName }}" class="w-16 h-16 object-cover rounded border">
                            {% else %}
                              <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">Нет фото</div>
                            {% endif %}
                          {% else %}
                            <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">Нет фото</div>
                          {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="text-sm font-medium">{{ p.productName }}</div>
                          {% if p.options is defined and p.options|length > 0 %}
                            <div class="mt-1 text-xs text-gray-600">
                              {% for o2 in p.options|sort((a,b) => (a.value.optionSortOrder ?? 9999) <=> (b.value.optionSortOrder ?? 9999) ?: ((a.value.valueSortOrder ?? 9999) <=> (b.value.valueSortOrder ?? 9999))) %}
                                {% set val = o2.value ?? {} %}
                                <span class="inline-block bg-gray-100 rounded px-2 py-0.5 mr-1 mb-1">{{ o2.optionName }}: {{ val.valueName ?? '-' }}</span>
                              {% endfor %}
                            </div>
                          {% endif %}
                          <div class="text-sm text-gray-700 mt-1">{{ format_price(unit) }} × {{ p.quantity }} = <span class="font-medium">{{ format_price(row) }}</span></div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  {% set d = o.delivery %}
                  {% set showManager = d and d.isCustomCalculate %}
                  {% set shippingCost = 0 %}
                  {% if d and d.cost is not null and not d.isFree and not showManager %}
                    {% set shippingCost = d.cost %}
                  {% endif %}

                  <div class="border-t mt-3 pt-3 text-sm">
                    <div>Стоимость товаров: <span data-testid="subtotal">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
                    {% if showManager or (d and d.cost is null) %}
                      <div>Доставка: <span data-testid="shipping">Расчет менеджером</span></div>
                      <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
                    {% elseif d and d.isFree %}
                      <div>Доставка: <span data-testid="shipping">Бесплатно</span></div>
                      <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
                    {% else %}
                      <div>Доставка: <span data-testid="shipping">{{ shippingCost|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
                      <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ (goodsSubtotal + shippingCost)|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="text-gray-500 text-sm">Позиции заказа отсутствуют</div>
                {% endif %}

                <div class="p-4 border rounded h-fit mt-4">
                  <h2 class="text-lg font-medium mb-3">Детали доставки</h2>
                  {% set d = o.delivery %}
                  {% if d %}
                    <div class="space-y-1 text-sm">
                      <div><span class="text-gray-600">Способ:</span> {{ delivery_type_name(d.type|default(null)) }}</div>
                      {% if d.city %}
                        <div><span class="text-gray-600">Город:</span> {{ d.city }}</div>
                      {% endif %}
                      {% if d.address %}
                        <div><span class="text-gray-600">Адрес:</span> {{ d.address }}</div>
                      {% endif %}
                      {% if d.pvz %}
                        <div><span class="text-gray-600">ПВЗ:</span> {{ d.pvz }}</div>
                      {% endif %}
                      {% if d.deliveryDate %}
                        <div><span class="text-gray-600">Дата доставки:</span> {{ d.deliveryDate|date('d.m.Y') }}</div>
                      {% endif %}
                      {% if d.deliveryTime %}
                        <div><span class="text-gray-600">Время доставки:</span> {{ d.deliveryTime|date('H:i') }}</div>
                      {% endif %}
                      {% if d.isCustomCalculate %}
                        <div class="text-xs text-gray-500">Стоимость доставки будет рассчитана менеджером</div>
                      {% elseif d.isFree %}
                        <div class="text-xs text-gray-500">Доставка бесплатная</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-sm text-gray-500">Детали доставки недоступны</div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-gray-600">У вас пока нет заказов.</div>
        {% endif %}
      </div>
      <div id="tabs-basic-filled-2" class="hidden" role="tabpanel" aria-labelledby="tabs-basic-filled-item-2">
      </div>
    </div>
  </div>
{% endblock %}


