{% extends 'catalog/base.html.twig' %}
{% import _self as account %}

{% block title %}Личный кабинет — {{ parent() }}{% endblock %}

{% block catalog_body %}
  <div class="container mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold text-gray-900 mb-6">Личный кабинет</h1>

    <nav class="tabs tabs-bordered tabs-lg overflow-x-auto" aria-label="Tabs" role="tablist" aria-orientation="horizontal">
      <button type="button" class="tab active-tab:tab-active active w-full" id="tabs-basic-filled-item-1" data-tab="#tabs-basic-filled-1" aria-controls="tabs-basic-filled-1" role="tab" aria-selected="true">
        Ваши заказы
      </button>
      <button type="button" class="tab active-tab:tab-active w-full" id="tabs-basic-filled-item-2" data-tab="#tabs-basic-filled-2" aria-controls="tabs-basic-filled-2" role="tab" aria-selected="false">
        Данные аккаунта
      </button>
    </nav>

    <div class="mt-3.5">
      <div id="tabs-basic-filled-1" role="tabpanel" aria-labelledby="tabs-basic-filled-item-1">
        {% set ordersList = orders|default([]) %}
        {% if ordersList|length > 0 %}
          <div class="space-y-6">
            {% for o in ordersList %}
              {{ account.order_card(o, statusNameById, productMap) }}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-gray-600">У вас пока нет заказов.</div>
        {% endif %}
      </div>
      <div id="tabs-basic-filled-2" class="hidden" role="tabpanel" aria-labelledby="tabs-basic-filled-item-2">
        <div class="max-w-xl">
          {% for label, messages in app.flashes %}
            {% for message in messages %}
              <div class="alert {{ label == 'success' ? 'alert-success' : (label == 'error' ? 'alert-error' : 'alert-info') }} mb-4">
                {{ message }}
              </div>
            {% endfor %}
          {% endfor %}

          <form action="{{ path('account_profile_update') }}" method="post" class="space-y-4">
            <input type="hidden" name="_token" value="{{ csrf_token('account_profile_update') }}">

            <div>
              <label for="firstName" class="label"><span class="label-text">Имя</span></label>
              <input id="firstName" name="firstName" type="text" class="input input-bordered w-full" value="{{ app.user and app.user.firstName ? app.user.firstName : '' }}" autocomplete="given-name">
            </div>

            <div>
              <label for="phone" class="label"><span class="label-text">Телефон</span></label>
              <input id="phone" name="phone" type="tel" class="input input-bordered w-full" value="{{ app.user and app.user.phone ? app.user.phone : '' }}" autocomplete="tel">
            </div>

            <div>
              <label for="email" class="label"><span class="label-text">Email</span></label>
              <input id="email" name="email" type="email" class="input input-bordered w-full" value="{{ app.user and app.user.email ? app.user.email : '' }}" autocomplete="email">
              <p class="text-xs text-gray-500 mt-1">Email используется для уведомлений и входа.</p>
            </div>

            <div class="pt-2">
              <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% macro order_card(order, statusMap, productMap) %}
  {% set orderProducts = order.products|default([]) %}
  {% set isCancelled = order.status == constant('App\\Entity\\Order::STATUS_CANCELLED') %}
  {% set delivery = order.delivery %}

  <div class="p-4 border rounded">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
      <div class="text-lg font-medium">Заказ <span class="font-mono">#{{ order.orderId }}</span></div>
      <div class="flex items-center gap-3 text-sm text-gray-700">
        <div>
          <span class="text-gray-500">Статус:</span>
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100">{{ statusMap[order.status]|default(order.status) }}</span>
        </div>
        <div><span class="text-gray-500">Дата:</span> {{ order.dateAdded ? order.dateAdded|date('d.m.Y') : '—' }}</div>
        {% if not isCancelled %}
          {{ account.order_cancel_button(order.orderId) }}
        {% endif %}
      </div>
    </div>

    {% if orderProducts|length > 0 %}
      {% set goodsSubtotal = 0 %}
      <div class="space-y-3" data-testid="order-items">
        {% for p in orderProducts %}
          {% set unit = (p.salePrice is not null and p.salePrice > 0) ? p.salePrice : (p.price ?? 0) %}
          {% set row = unit * (p.quantity ?? 0) %}
          {% set goodsSubtotal = goodsSubtotal + row %}
          <div class="flex gap-3 items-start border-b pb-3" data-testid="order-item">
            <div class="w-16 h-16 shrink-0">
              {{ account.product_image(productMap[p.productId]|default(null), p.productName|default('')) }}
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium">{{ p.productName }}</div>
              {{ account.product_options(p.options|default([])) }}
              <div class="text-sm text-gray-700 mt-1">{{ format_price(unit) }} × {{ p.quantity }} = <span class="font-medium">{{ format_price(row) }}</span></div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% set showManager = delivery and delivery.isCustomCalculate %}
      {% set shippingCost = 0 %}
      {% if delivery and delivery.cost is not null and not delivery.isFree and not showManager %}
        {% set shippingCost = delivery.cost %}
      {% endif %}

      <div class="border-t mt-3 pt-3 text-sm">
        <div>Стоимость товаров: <span data-testid="subtotal">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        {% if showManager or (delivery and delivery.cost is null) %}
          <div>Доставка: <span data-testid="shipping">Расчет менеджером</span></div>
          <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        {% elseif delivery and delivery.isFree %}
          <div>Доставка: <span data-testid="shipping">Бесплатно</span></div>
          <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ goodsSubtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        {% else %}
          <div>Доставка: <span data-testid="shipping">{{ shippingCost|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
          <div class="border-t pt-2 font-semibold">Итого: <span data-testid="total">{{ (goodsSubtotal + shippingCost)|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        {% endif %}
      </div>
    {% else %}
      <div class="text-gray-500 text-sm">Позиции заказа отсутствуют</div>
    {% endif %}

    {{ account.delivery_details(delivery) }}
  </div>
{% endmacro %}

{% macro order_cancel_button(orderId) %}
  <button type="button" class="btn btn-xs btn-outline btn-error ml-2" aria-haspopup="dialog" aria-expanded="false" aria-controls="cancel-modal-{{ orderId }}" data-overlay="#cancel-modal-{{ orderId }}">Отменить заказ</button>

  <div id="cancel-modal-{{ orderId }}" class="overlay modal overlay-open:opacity-100 hidden overlay-open:duration-300 z-[120]" role="dialog" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Подтверждение</h3>
          <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close" data-overlay="#cancel-modal-{{ orderId }}">
            <span class="icon-[tabler--x] size-4"></span>
          </button>
        </div>
        <div class="modal-body">
          Вы уверены, что хотите отменить заказ <span class="font-mono">#{{ orderId }}</span>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-soft btn-secondary" data-overlay="#cancel-modal-{{ orderId }}">Отмена</button>
          <form action="{{ path('account_order_cancel', { orderId: orderId }) }}" method="post" class="inline">
            <input type="hidden" name="_token" value="{{ csrf_token('order_cancel_' ~ orderId) }}">
            <button type="submit" class="btn btn-primary">Да, отменить</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endmacro %}

{% macro delivery_details(delivery) %}
  <div class="p-4 border rounded h-fit mt-4">
    <h2 class="text-lg font-medium mb-3">Детали доставки</h2>
    {% if delivery %}
      <div class="space-y-1 text-sm">
        {% set rows = {
          'Способ': delivery_type_name(delivery.type|default(null)),
          'Город': delivery.city|default(null),
          'Адрес': delivery.address|default(null),
          'ПВЗ': delivery.pvz|default(null),
          'Дата доставки': delivery.deliveryDate ? delivery.deliveryDate|date('d.m.Y') : null,
          'Время доставки': delivery.deliveryTime ? delivery.deliveryTime|date('H:i') : null
        } %}
        {% for label, value in rows %}
          {% if value is not null and value is not same as(false) and value is not same as('') %}
            <div><span class="text-gray-600">{{ label }}:</span> {{ value }}</div>
          {% endif %}
        {% endfor %}
        {% if delivery.isCustomCalculate %}
          <div class="text-xs text-gray-500">Стоимость доставки будет рассчитана менеджером</div>
        {% elseif delivery.isFree %}
          <div class="text-xs text-gray-500">Доставка бесплатная</div>
        {% endif %}
      </div>
    {% else %}
      <div class="text-sm text-gray-500">Детали доставки недоступны</div>
    {% endif %}
  </div>
{% endmacro %}

{% macro product_image(product, alt) %}
  {% if product and product.image|length > 0 %}
    {% set firstImage = product.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
    {% if firstImage and firstImage.imageUrl is defined %}
      {% set raw = firstImage.imageUrl %}
      {% if raw starts with '/media/cache/' %}
        {% set imgSrc = raw %}
      {% else %}
        {% set rel = raw|replace({'/img/':''})|trim('/') %}
        {% set imgSrc = asset('/img/' ~ rel)|imagine_filter('md2') %}
      {% endif %}
      <img src="{{ imgSrc }}" alt="{{ alt }}" class="w-16 h-16 object-cover rounded border">
    {% else %}
      {{ account.placeholder_image() }}
    {% endif %}
  {% else %}
    {{ account.placeholder_image() }}
  {% endif %}
{% endmacro %}

{% macro placeholder_image() %}
  <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">Нет фото</div>
{% endmacro %}

{% macro product_options(options) %}
  {% if options|length > 0 %}
    <div class="mt-1 text-xs text-gray-600">
      {% for option in options|sort((a,b) => (a.value.optionSortOrder ?? 9999) <=> (b.value.optionSortOrder ?? 9999) ?: ((a.value.valueSortOrder ?? 9999) <=> (b.value.valueSortOrder ?? 9999))) %}
        {% set val = option.value ?? {} %}
        <span class="inline-block bg-gray-100 rounded px-2 py-0.5 mr-1 mb-1">{{ option.optionName }}: {{ val.valueName ?? '-' }}</span>
      {% endfor %}
    </div>
  {% endif %}
{% endmacro %}


