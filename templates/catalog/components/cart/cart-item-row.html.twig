{# ai:component=cart-item-row map=@component_cart-item-row_map.mdc v=1 #}
<tr class="border-b" data-item-id="{{ item.id }}" data-testid="cart-item">
  <td class="py-2 pr-4">
    {% if item.product and item.product.image|length > 0 %}
      {% set firstImage = item.product.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
      {% if firstImage %}
        {% set raw = firstImage.imageUrl %}
        {% if raw starts with '/media/cache/' %}
          {% set imgSrc = raw %}
        {% else %}
          {% set rel = raw|replace({'/img/':''})|trim('/') %}
          {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
        {% endif %}
        <img src="{{ imgSrc }}" alt="{{ item.productName }}" class="w-16 h-16 object-cover rounded border">
      {% else %}
        <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">Нет фото</div>
      {% endif %}
    {% else %}
      <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">Нет фото</div>
    {% endif %}
  </td>

  <td class="py-2 pr-4">
    {% if item.product and item.product.slug %}
      <a href="{{ path('catalog_product_show', {'slug': item.product.slug}) }}" class="text-blue-600 hover:text-blue-800 hover:underline">
        {{ item.productName }}
      </a>
    {% else %}
      {{ item.productName }}
    {% endif %}

    {% if item.optionAssignments is defined and item.optionAssignments|length > 0 %}
      {% set sortedAssignments = item.optionAssignments
        |sort((a,b) => (a.option.sortOrder <=> b.option.sortOrder) ?: ((a.sortOrder ?? 2147483647) <=> (b.sortOrder ?? 2147483647))) %}
      <div class="mt-1 text-xs text-gray-600">
        {% for assignment in sortedAssignments %}
          <span class="inline-block bg-gray-100 rounded px-2 py-1 mr-1 mb-1">
            {{ assignment.option.name }}: {{ assignment.value.value }}
          </span>
        {% endfor %}
      </div>
    {% endif %}
  </td>

  <td class="py-2 pr-4">
    {# Показываем цену со скидкой и без скидки (Simple/Variable) #}
    {% set discountedPrice = item.effectiveUnitPrice > 0 ? item.effectiveUnitPrice : item.unitPrice %}
    {% set hasOptions = item.optionAssignments is defined and item.optionAssignments|length > 0 %}
    {% set originalPrice = null %}
    {% set hasDiscount = false %}

    {% if hasOptions %}
      {% set matchFound = false %}
      {% for a in item.optionAssignments %}
        {% set candidate = a.salePrice is not null ? a.salePrice : (a.price ?? 0) %}
        {% if not matchFound and candidate == discountedPrice and a.salePrice is not null and a.price is not null and a.salePrice < a.price %}
          {% set originalPrice = a.price %}
          {% set hasDiscount = true %}
          {% set matchFound = true %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% if item.product and item.product.salePrice is not null and item.product.price is not null and item.product.salePrice < item.product.price %}
        {% set originalPrice = item.product.price %}
        {% set hasDiscount = true %}
        {% set discountedPrice = item.product.salePrice %}
      {% endif %}
    {% endif %}

    {% if hasDiscount %}
      <div class="flex items-center gap-2">
        <span class="line-through text-gray-500 text-sm">{{ format_price(originalPrice) }}</span>
        <span class="text-red-600 font-medium">{{ format_price(discountedPrice) }}</span>
      </div>
    {% else %}
      {{ format_price(discountedPrice) }}
    {% endif %}
  </td>

  <td class="py-2 pr-4">
    <input
      type="number"
      class="qty-input w-20 border rounded px-2 py-1"
      value="{{ item.qty }}"
      min="1"
      data-item-id="{{ item.id }}"
      data-testid="qty-input"
    >
  </td>

  <td class="py-2 pr-4 row-total" data-testid="row-total">{{ format_price(item.rowTotal) }}</td>

  <td class="py-2 pr-4">
    <button class="remove text-red-600 hover:underline" data-item-id="{{ item.id }}" data-testid="remove">
      Удалить
    </button>
  </td>
</tr>


