{# Сетка товаров: ожидает переменные `products`, `total`, `page`, `limit`, `slug` #}
<div class="bg-white">
  <div class="mx-auto max-w-2xl lg:max-w-7xl">
    {% if gridTitle is defined %}
      <h2 class="text-2xl font-bold tracking-tight text-gray-900">{{ gridTitle }}</h2>
    {% endif %}

    <div class="mt-6 grid grid-cols-1 gap-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4" data-testid="category-grid">
      {% for p in products %}
        {# Подготовка данных для вариаций #}
        {% set variationsToShow = [] %}
        {% set setPriceVariation = null %}
        {% if p.type == 'variable' %}
          {% for assignment in p.optionAssignments %}
            {% if assignment.getSetPrice() %}
              {% set setPriceVariation = assignment %}
            {% endif %}
          {% endfor %}
          {% if setPriceVariation %}
            {% set targetOptionId = setPriceVariation.option.id %}
            {% for assignment in p.optionAssignments %}
              {% if assignment.option.id == targetOptionId %}
                {% set variationsToShow = variationsToShow|merge([assignment]) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}

        <div class="group relative px-2 pt-2 category-shadow rounded-t-md">
          <div class="relative">
            {% if p.image|length > 0 %}
              {% set firstImage = p.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
              {% set imagesCount = p.image|length %}
              {% if firstImage %}
                {% set raw = firstImage.imageUrl %}
                {% if raw starts with '/media/cache/' %}
                  {% set imgSrc = raw %}
                {% else %}
                  {% set rel = raw|replace({'/img/':''})|trim('/') %}
                  {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
                {% endif %}
                <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                  <img src="{{ imgSrc }}" alt="{{ p.name }}" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto">
                </a>
                {% if imagesCount > 1 %}
                  <div class="absolute bottom-0 left-0 right-0 flex h-full mb-1">
                    {% for i in 1..imagesCount %}
                      <div class="flex-1 border-b-2 border-yellow-500 mx-1"></div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% else %}
                <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                  <img src="https://via.placeholder.com/500" alt="{{ p.name }}" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto">
                </a>
              {% endif %}
            {% else %}
              <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                <img src="https://via.placeholder.com/500" alt="{{ p.name }}" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto">
              </a>
            {% endif %}
          </div>

          {% set inWishlist = wishlist_has(p.id) %}
          <button type="button"
                  aria-label="В избранное"
                  title="В избранное"
                  data-module="wishlist-toggle"
                  data-spinner="false"
                  data-product-id="{{ p.id }}"
                  class="absolute right-3 top-3 z-10 rounded-full bg-white/80 p-2 text-gray-600 shadow-sm hover:text-red-500"
                  {% if inWishlist %}data-state="active"{% endif %}>
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"/>
            </svg>
          </button>

          <div class="mt-4 flex justify-between">
            <div>
              <div class="text-sm text-gray-700">
                <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">                  
                  {{ p.name }}
                </a>
              </div>
              
            </div>
            
          </div>

<div class="mt-1 flex justify-between">
          <div class="text-left">
              {% if p.type == 'simple' or p.type == 'variable_no_prices' %}
                {% set hasDiscount = p.salePrice is not null and p.price is not null and p.salePrice < p.price %}
                {% if hasDiscount %}
                  <div class="flex items-center gap-2 justify-end">
                    <span class="line-through text-gray-500 text-sm">{{ format_price(p.price)|replace({'₽':'руб.'}) }}</span>
                    <span class="text-red-600 font-medium">{{ format_price(p.salePrice)|replace({'₽':'руб.'}) }}</span>
                  </div>
                {% elseif p.price is not null %}
                  {{ format_price(p.price)|replace({'₽':'руб.'}) }}
                {% endif %}
              {% elseif p.type == 'variable' %}
                {% if setPriceVariation %}
                  {% set hasDiscount = setPriceVariation.salePrice is not null and setPriceVariation.price is not null and setPriceVariation.salePrice < setPriceVariation.price %}
                  {% if hasDiscount %}
                    <div class="flex items-center gap-2 justify-end">
                      <span class="line-through text-gray-500 text-sm">{{ format_price(setPriceVariation.price)|replace({'₽':'руб.'}) }}</span>
                      <span class="text-red-600 font-medium">{{ format_price(setPriceVariation.salePrice)|replace({'₽':'руб.'}) }}</span>
                    </div>
                  {% else %}
                    {% set basePrice = setPriceVariation.salePrice is not null ? setPriceVariation.salePrice : (setPriceVariation.price ?? null) %}
                    {% if basePrice is not null %}{{ format_price(basePrice)|replace({'₽':'руб.'}) }}{% endif %}
                  {% endif %}
                {% elseif p.effectivePrice %}
                  {{ format_price(p.effectivePrice)|replace({'₽':'руб.'}) }}
                {% endif %}
              {% endif %}
            </div>
            </div>
          
          {% if p.type == 'variable' and setPriceVariation %}
          <div class="flex justify-between">
              <p class="mt-1 text-sm text-gray-500">
                  
                    {% if setPriceVariation.height %}Высота: {{ setPriceVariation.height }} см{% endif %}
                    {% if setPriceVariation.height and setPriceVariation.bulbsCount %} • {% endif %}
                    {% if setPriceVariation.bulbsCount %}Лампочки: {{ setPriceVariation.bulbsCount }}{% endif %}
                  
              </p>
            </div>
            {% endif %}
            
          
<div 
            class="space-y-2 px-2 pb-2 block opacity-0 pointer-events-none transition-opacity duration-200 ease-out group-hover:opacity-100 group-hover:pointer-events-auto absolute inset-x-0 top-full -mt-px z-50 bg-white shadow-lg border-gray-200 border-t-0 rounded-b"
            style="width: 100%;"
            >
          {% if variationsToShow|length > 1 %}
            
              {% for variation in variationsToShow %}
                <div class="flex items-center justify-between text-xs text-gray-700">
                  <div class="truncate">{{ variation.value.value }}</div>
                  <div class="mx-2 text-gray-500">
                    {% if variation.height %}Высота: {{ variation.height }} см{% endif %}
                    {% if variation.height and variation.bulbsCount %} • {% endif %}
                    {% if variation.bulbsCount %}Лампочки: {{ variation.bulbsCount }}{% endif %}
                  </div>
                  
                </div>
                <div class="text-left">
                    {% set hasDiscount = variation.salePrice is not null and variation.price is not null and variation.salePrice < variation.price %}
                    {% if hasDiscount %}
                      <div class="flex items-center gap-2">
                        <span class="line-through text-gray-500 text-sm">{{ format_price(variation.price)|replace({'₽':'руб.'}) }}</span>
                        <span class="text-red-600 font-medium">{{ format_price(variation.salePrice)|replace({'₽':'руб.'}) }}</span>
                      </div>
                    {% else %}
                      {% set basePrice = variation.salePrice is not null ? variation.salePrice : (variation.price ?? null) %}
                      {% if basePrice is not null %}{{ format_price(basePrice)|replace({'₽':'руб.'}) }}{% endif %}
                    {% endif %}
                  </div>
              {% endfor %}
            
          {% endif %}
          
          {# Кнопка Купить #}
          <button type="button" 
                  data-product-id="{{ p.id }}"
                  data-module="add-to-cart"
                  data-testid="add-to-cart-grid"
                  class="w-full h-10 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:pointer-events-none disabled:transform-none relative overflow-hidden group">
            <div class="relative flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-200 group-hover:scale-110">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
              </svg>
              <span class="text-sm transition-all duration-200 group-hover:tracking-wide">Купить</span>
            </div>
            <div class="loading-spinner absolute inset-0 flex items-center justify-center opacity-0">
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </button>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Пагинация #}
    {% set totalPages = (total is defined and limit is defined and limit > 0) ? ((total + limit - 1) // limit) : 1 %}
    {% if totalPages > 1 %}
      {% set q = app.request.query.all %}
      {% set baseParams = q|merge({ 'limit': limit }) %}
      {# Выбираем маршрут пагинации: поиск или категория #}
      {% set baseRouteName = routeName|default('catalog_category_products') %}
      {% set baseRouteParams = routeParams is defined ? routeParams : (slug is defined ? { 'slug': slug } : {}) %}
      {% if baseParams['page'] is defined %}
        {% set baseParams = baseParams|merge({ 'page': null }) %}
      {% endif %}
      <nav aria-label="Pagination" class="mt-8 pt-8 flex items-center justify-center border-t border-gray-200">
        <div class="flex items-center gap-x-1">
          {% if page > 1 %}
            {% set prevParams = baseParams|merge({ 'page': page - 1 }) %}
            <a class="btn btn-soft max-sm:btn-square" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ prevParams|url_encode }}">
              <span class="icon-[tabler--chevron-left] size-5 rtl:rotate-180"></span>
              <span class="hidden sm:inline">Назад</span>
            </a>
          {% else %}
            <span class="btn btn-soft max-sm:btn-square pointer-events-none opacity-50" aria-disabled="true">
              <span class="icon-[tabler--chevron-left] size-5 rtl:rotate-180"></span>
              <span class="hidden sm:inline">Назад</span>
            </span>
          {% endif %}

          <div class="flex items-center gap-x-1">
            {% for p in 1..totalPages %}
              {% set pParams = baseParams|merge({ 'page': p }) %}
              {% if p == page %}
                <a class="btn btn-soft btn-square aria-[current='page']:text-bg-soft-primary" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ pParams|url_encode }}" aria-current="page">{{ p }}</a>
              {% else %}
                <a class="btn btn-soft btn-square aria-[current='page']:text-bg-soft-primary" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ pParams|url_encode }}">{{ p }}</a>
              {% endif %}
            {% endfor %}
          </div>

          {% if page < totalPages %}
            {% set nextParams = baseParams|merge({ 'page': page + 1 }) %}
            <a class="btn btn-soft max-sm:btn-square" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ nextParams|url_encode }}">
              <span class="hidden sm:inline">Вперёд</span>
              <span class="icon-[tabler--chevron-right] size-5 rtl:rotate-180"></span>
            </a>
          {% else %}
            <span class="btn btn-soft max-sm:btn-square pointer-events-none opacity-50" aria-disabled="true">
              <span class="hidden sm:inline">Вперёд</span>
              <span class="icon-[tabler--chevron-right] size-5 rtl:rotate-180"></span>
            </span>
          {% endif %}
        </div>
      </nav>
    {% endif %}
  </div>
</div>




