{# Сетка товаров: ожидает переменную `products` #}
<div class="grid lg:grid-cols-5 md:grid-cols-3 gap-4 mb-6">
  {% for p in products %}
    <div class="relative rounded-lg break-words border bg-white border-gray-300 card-product">
        <div class="flex-auto p-4">
        <div class="text-center relative flex justify-center">
          {% set firstImage = p.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
          {% if firstImage %}
            {% set raw = firstImage.imageUrl %}
            {% if raw starts with '/media/cache/' %}
              {% set imgSrc = raw %}
            {% else %}
              {% set rel = raw|replace({'/img/':''})|trim('/') %}
              {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
            {% endif %}
            <a href="{{ path('catalog_product_show', { slug: p.slug }) }}"><img src="{{ imgSrc }}" alt="{{ p.name }}" class="w-full h-auto"></a>
          {% else %}
            <a href="{{ path('catalog_product_show', { slug: p.slug }) }}"><img src="https://via.placeholder.com/500" alt="{{ p.name }}" class="w-full h-auto"></a>
          {% endif %}
            {# Иконка избранного в углу карточки #}
            {% set inWishlist = wishlist_has(p.id) %}
            <button type="button"
                    class="absolute top-2 right-2 inline-flex items-center justify-center w-9 h-9 rounded-full bg-white/90 shadow hover:bg-white transition-colors{% if inWishlist %} is-active{% endif %}"
                    aria-label="В избранное"
                    title="В избранное"
                    data-module="wishlist-toggle"
                    data-spinner="false"
                    data-product-id="{{ p.id }}">
              <svg class="w-5 h-5 {% if inWishlist %}text-red-600{% else %}text-gray-600{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"/>
              </svg>
            </button>
        </div>

        <div class="flex flex-col gap-3 mt-3">
          <div class="flex flex-col gap-2">
            <h3 class="text-base truncate"><a href="{{ path('catalog_product_show', { slug: p.slug }) }}">{{ p.name }}</a></h3>
          </div>

          <div class="flex justify-between items-center">
            <div>
              {% if p.getEffectivePrice() %}
                <span class="text-gray-900 font-semibold">{{ p.getEffectivePrice() }}</span>
              {% endif %}
            </div>
            <div>
              <button type="button" data-product-id="{{ p.id }}" class="js-add-to-cart btn inline-flex items-center gap-x-1 bg-green-600 text-white border-green-600 disabled:opacity-50 disabled:pointer-events-none hover:text-white hover:bg-green-700 hover:border-green-700 active:bg-green-700 active:border-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 btn-sm">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                </svg>
                <span>Купить</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>




