{# –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤: –æ–∂–∏–¥–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `products`, `total`, `page`, `limit`, `slug` #}
<div class="grid gap-6 overflow-visible mb-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4" data-testid="category-grid">
  {% for p in products %}
    <div class="card-product group">
      <div class="relative z-[1] flex-auto p-5">
        <div class="card-product__media relative flex justify-center overflow-visible text-center" data-controller="hover-gallery" data-action="mouseenter->hover-gallery#loadThumbs focusin->hover-gallery#loadThumbs touchstart->hover-gallery#loadThumbs">
          {% set firstImage = p.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
          {% if firstImage %}
            {% set raw = firstImage.imageUrl %}
            {% if raw starts with '/media/cache/' %}
              {% set imgSrc = raw %}
            {% else %}
              {% set rel = raw|replace({'/img/':''})|trim('/') %}
              {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
            {% endif %}
            <a href="{{ path('catalog_product_show', { slug: p.slug }) }}"><img src="{{ imgSrc }}" alt="{{ p.name }}" class="w-full h-auto"></a>
          {% else %}
            <a href="{{ path('catalog_product_show', { slug: p.slug }) }}"><img src="https://via.placeholder.com/500" alt="{{ p.name }}" class="w-full h-auto"></a>
          {% endif %}
            {# –ò–∫–æ–Ω–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ —É–≥–ª—É –∫–∞—Ä—Ç–æ—á–∫–∏ #}
            {% set inWishlist = wishlist_has(p.id) %}
            <button type="button"
                    class="absolute top-2 right-2 inline-flex items-center justify-center w-9 h-9 rounded-full bg-white/90 shadow hover:bg-white transition-colors{% if inWishlist %} is-active{% endif %}"
                    aria-label="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
                    title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
                    data-module="wishlist-toggle"
                    data-spinner="false"
                    data-product-id="{{ p.id }}">
              <svg class="w-5 h-5 {% if inWishlist %}text-red-600{% else %}text-gray-600{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"/>
              </svg>
            </button>
            {# Overlay: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–æ—Ç–æ, –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è img #}
            {% set imagesSorted = p.image|sort((a,b) => a.sortOrder <=> b.sortOrder) %}
            <div class="card-product__overlay" aria-hidden="true">
              <div class="hover-left">
                {% for im in imagesSorted|slice(0,3) %}
                  {% set tRaw = im.imageUrl %}
                  {% if tRaw starts with '/media/cache/' %}
                    {% set tSrc = tRaw %}
                  {% else %}
                    {% set tRel = tRaw|replace({'/img/':''})|trim('/') %}
                    {% set tSrc = asset('/img/' ~ tRel) | imagine_filter('md2') %}
                  {% endif %}
                  <div class="card-product__thumb{% if loop.first %} is-active{% endif %}" data-bg="{{ tSrc }}"><img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="{{ tSrc }}" alt="{{ p.name }} –º–∏–Ω–∏–∞—Ç—é—Ä–∞ {{ loop.index }}"></div>
                {% endfor %}
              </div>
              <a class="pointer-events-auto absolute left-4 bottom-4 z-10 inline-flex items-center gap-2 rounded-[10px] bg-white/90 px-4 py-3 font-semibold text-slate-900 shadow-lg transition-colors duration-200 hover:bg-white" href="{{ path('catalog_product_show', { slug: p.slug }) }}#gallery">üîç –£–≤–µ–ª–∏—á–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</a>
              {#<div class="hover-content">
                <div class="text-sm text-gray-500">–•—Ä—É—Å—Ç–∞–ª—å–Ω–∞—è –ª—é—Å—Ç—Ä–∞</div>
                <a class="hover-title" href="{{ path('catalog_product_show', { slug: p.slug }) }}">{{ p.name }}</a>
                {% if p.getEffectivePrice() %}
                  <div class="hover-price">{{ p.getEffectivePrice() }} <span class="font-semibold">—Ä—É–±.</span></div>
                {% endif %}
                <button type="button" data-product-id="{{ p.id }}" class="js-add-to-cart buy-btn inline-flex items-center justify-center gap-x-2">
                  <span>–ö—É–ø–∏—Ç—å</span>
                </button>
                <div class="stock"><span>‚úî</span><span>–í –Ω–∞–ª–∏—á–∏–∏</span></div>
              </div>#}
            </div>
        </div>

        <div class="flex flex-col gap-4 mt-4">
          <div class="flex flex-col gap-1.5">
            <h3 class="text-base font-medium text-slate-900"><a href="{{ path('catalog_product_show', { slug: p.slug }) }}" class="transition-colors hover:text-slate-700">{{ p.name }}</a></h3>
          </div>

          <div class="flex items-center justify-between">
            <div>
              {% if p.getEffectivePrice() %}
                <span class="text-lg font-semibold text-slate-900">{{ p.getEffectivePrice() }}</span>
              {% endif %}
            </div>
            <div>
              <button type="button" data-product-id="{{ p.id }}" class="js-add-to-cart btn inline-flex items-center gap-x-1 bg-green-600 text-white border-green-600 disabled:opacity-50 disabled:pointer-events-none hover:text-white hover:bg-green-700 hover:border-green-700 active:bg-green-700 active:border-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 btn-sm">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                </svg>
                <span>–ö—É–ø–∏—Ç—å</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  {% endfor %}
</div>

{# –ü–∞–≥–∏–Ω–∞—Ü–∏—è #}
{% set totalPages = (total is defined and limit is defined and limit > 0) ? ((total + limit - 1) // limit) : 1 %}
{% if totalPages > 1 %}
  {% set q = app.request.query.all %}
  {% set baseParams = q|merge({ 'limit': limit }) %}
  {# –í—ã–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: –ø–æ–∏—Å–∫ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è #}
  {% set baseRouteName = routeName|default('catalog_category_products') %}
  {% set baseRouteParams = routeParams is defined ? routeParams : (slug is defined ? { 'slug': slug } : {}) %}
  {% if baseParams['page'] is defined %}
    {% set baseParams = baseParams|merge({ 'page': null }) %}
  {% endif %}
  <nav class="flex items-center justify-center gap-2" aria-label="Pagination">
    {# Prev #}
    {% if page > 1 %}
      {% set prevParams = baseParams|merge({ 'page': page - 1 }) %}
      <a class="px-3 py-1 border rounded" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ prevParams|url_encode }}">–ù–∞–∑–∞–¥</a>
    {% else %}
      <span class="px-3 py-1 border rounded text-gray-400">–ù–∞–∑–∞–¥</span>
    {% endif %}

    {# Pages #}
    {% for p in 1..totalPages %}
      {% set pParams = baseParams|merge({ 'page': p }) %}
      {% if p == page %}
        <span class="px-3 py-1 border rounded bg-gray-200">{{ p }}</span>
      {% else %}
        <a class="px-3 py-1 border rounded" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ pParams|url_encode }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {# Next #}
    {% if page < totalPages %}
      {% set nextParams = baseParams|merge({ 'page': page + 1 }) %}
      <a class="px-3 py-1 border rounded" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ nextParams|url_encode }}">–í–ø–µ—Ä—ë–¥</a>
    {% else %}
      <span class="px-3 py-1 border rounded text-gray-400">–í–ø–µ—Ä—ë–¥</span>
    {% endif %}
  </nav>
{% endif %}




