{# Сетка товаров: ожидает переменные `products`, `total`, `page`, `limit`, `slug` #}
<div class="bg-white">
  <div class="mx-auto">
    {% if gridTitle is defined %}
      <h2 class="text-2xl font-bold tracking-tight text-gray-900">{{ gridTitle }}</h2>
    {% endif %}

    <div class="{{ gridClasses|default('mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4') }}" data-testid="category-grid">
      {% for p in products %}
        {# Подготовка данных для вариаций #}
        {% set variationsToShow = [] %}
        {% set setPriceVariation = null %}
        {% if p.type == 'variable' %}
          {% for assignment in p.optionAssignments %}
            {% if assignment.getSetPrice() %}
              {% set setPriceVariation = assignment %}
            {% endif %}
          {% endfor %}
          {% if setPriceVariation %}
            {% set targetOptionId = setPriceVariation.option.id %}
            {% for assignment in p.optionAssignments %}
              {% if assignment.option.id == targetOptionId %}
                {% set variationsToShow = variationsToShow|merge([assignment]) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}

        {# Собираем упорядоченный список изображений и их URL #}
        {% set sortedImages = p.image|sort((a,b) => a.sortOrder <=> b.sortOrder) %}
        {% set imageUrls = [] %}
        {% for image in sortedImages %}
          {% set raw = image.imageUrl %}
          {% if raw starts with '/media/cache/' %}
            {% set imgUrl = raw %}
          {% else %}
            {% set rel = raw|replace({'/img/':''})|trim('/') %}
            {% set imgUrl = asset('/img/' ~ rel) | imagine_filter('md2') %}
          {% endif %}
          {% set imageUrls = imageUrls|merge([imgUrl]) %}
        {% endfor %}

        <div class="group relative {% if isInSlider is defined and isInSlider %}px-4{% else %}px-2{% endif %} pt-4 {% if isInSlider is defined and isInSlider %}pb-4{% else %}pb-3{% endif %} category-shadow border-b border-t border-gray-200{% if isInSlider is defined and isInSlider %} border-l border-r rounded{% endif %}" data-controller="product-gallery" data-product-gallery-images-value="{{ imageUrls|json_encode|e('html_attr') }}">
          <div class="group/image relative">
            {% if p.image|length > 0 %}
              {% set firstImage = sortedImages|first %}
              {% set imagesCount = p.image|length %}
              {% if firstImage %}
                {% set raw = firstImage.imageUrl %}
                {% if raw starts with '/media/cache/' %}
                  {% set imgSrc = raw %}
                {% else %}
                  {% set rel = raw|replace({'/img/':''})|trim('/') %}
                  {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
                {% endif %}
                <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                  <img src="{{ imgSrc }}" alt="{{ p.name }}" loading="lazy" decoding="async" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto" data-product-gallery-target="image">
                </a>
                {% if imagesCount > 1 %}
                  <div class="absolute bottom-0 left-0 right-0 flex h-full mb-1 pointer-events-none">
                    {% for i in 1..imagesCount %}
                      <div class="flex-1 border-b-2 {{ loop.first ? 'border-yellow-500' : 'border-gray-300' }} hover:border-yellow-500 hover:cursor-pointer mx-1 pointer-events-auto" data-action="mouseenter->product-gallery#showImage click->product-gallery#navigateToProduct" data-product-gallery-image-index-value="{{ loop.index0 }}" data-product-gallery-target="indicator"></div>
                    {% endfor %}
                  </div>
                {% endif %}
                {# Кнопка Быстрый просмотр #}
                <button type="button"
                        aria-label="Быстрый просмотр"
                        title="Быстрый просмотр"
                        data-action="click->product-gallery#openFancybox"
                        class="absolute bottom-4 left-1/2 -translate-x-1/2 w-fit h-fit px-4 py-2 bg-white/70 backdrop-blur-sm text-gray-900 text-sm rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity duration-200 ease-in-out group-hover:opacity-100 group-hover:pointer-events-auto hover:bg-white/90 z-20 whitespace-nowrap">
                  <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    Быстрый просмотр
                  </span>
                </button>
              {% else %}
                <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                  <img src="https://via.placeholder.com/500" alt="{{ p.name }}" loading="lazy" decoding="async" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto">
                </a>
              {% endif %}
            {% else %}
              <a href="{{ path('catalog_product_show', { slug: p.slug }) }}">
                <img src="https://via.placeholder.com/500" alt="{{ p.name }}" loading="lazy" decoding="async" class="aspect-square rounded-t w-full rounded-md bg-gray-200 object-cover lg:aspect-auto">
              </a>
            {% endif %}
            {% set inWishlist = wishlist_has(p.id) %}
            <button type="button"
                    aria-label="В избранное"
                    title="В избранное"
                    data-module="wishlist-toggle"
                    data-spinner="false"
                    data-product-id="{{ p.id }}"
                    class="absolute right-2 top-2 z-10 rounded-full p-2 text-gray-400 shadow-sm hover:text-red-500 opacity-0 pointer-events-none transition-opacity duration-200 ease-in-out group-hover/image:opacity-100 group-hover/image:pointer-events-auto {% if inWishlist %}is-active text-red-500{% endif %}"
                    {% if inWishlist %}data-state="active"{% endif %}>
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" class="h-5 w-5">
                <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
              </svg>

            </button>
          </div>

          <div class="mt-2 flex justify-between leading-4">
            <div class="min-w-0 flex-1">
              <div class="text-base leading-4 text-blue-600">
                <a class="block truncate" href="{{ path('catalog_product_show', { slug: p.slug }) }}" title="{{ p.name }}">                  
                  {{ p.name }}
                </a>
              </div>
              
            </div>
            
          </div>

<div class="mt-2 flex justify-between leading-4 text-lg ">
          <div class="text-left font-medium">
              {% if p.type == 'simple' or p.type == 'variable_no_prices' %}
                {% set hasDiscount = p.salePrice is not null and p.price is not null and p.salePrice < p.price %}
                {% if hasDiscount %}
                  <div class="flex items-center gap-2 justify-end align-bottom">
                    <span class="line-through text-gray-500 text-sm leading-4">{{ format_price(p.price)|replace({'₽':'руб.'}) }}</span>
                    <span class="text-red-600 font-medium text-lg leading-4">{{ format_price(p.salePrice)|replace({'₽':'руб.'}) }}</span>
                  </div>
                {% elseif p.price is not null %}
                  {{ format_price(p.price)|replace({'₽':'руб.'}) }}
                {% endif %}
              {% elseif p.type == 'variable' %}
                {% if setPriceVariation %}
                  {% set hasDiscount = setPriceVariation.salePrice is not null and setPriceVariation.price is not null and setPriceVariation.salePrice < setPriceVariation.price %}
                  {% if hasDiscount %}
                    <div class="flex items-center gap-2 justify-end">
                      <span class="line-through text-gray-500 text-sm leading-4">{{ format_price(setPriceVariation.price)|replace({'₽':'руб.'}) }}</span>
                      <span class="text-red-600 font-medium text-lg leading-4">{{ format_price(setPriceVariation.salePrice)|replace({'₽':'руб.'}) }}</span>
                    </div>
                  {% else %}
                    {% set basePrice = setPriceVariation.salePrice is not null ? setPriceVariation.salePrice : (setPriceVariation.price ?? null) %}
                    {% if basePrice is not null %}{{ format_price(basePrice)|replace({'₽':'руб.'}) }}{% endif %}
                  {% endif %}
                {% elseif p.effectivePrice %}
                  {{ format_price(p.effectivePrice)|replace({'₽':'руб.'}) }}
                {% endif %}
              {% endif %}
            </div>
            </div>
          
          {% if p.type == 'variable' and setPriceVariation and not (isInSlider is defined and isInSlider) %}
          {% set optionLabel = setPriceVariation.option is not null ? setPriceVariation.option.name : null %}
          {% set valueLabel = setPriceVariation.value is not null ? setPriceVariation.value.value : null %}
          {% set hasLabel = optionLabel or valueLabel %}
          {% set hasHeight = setPriceVariation.height is not null %}
          {% set hasBulbs = setPriceVariation.bulbsCount is not null %}
          {% set hasSpecs = hasHeight or hasBulbs %}
          <div class="flex justify-between">
              <p class="text-xs text-gray-700">
                    {% if hasLabel %}
                      {% if optionLabel %}{{ optionLabel }}{% endif %}
                      {% if optionLabel and valueLabel %}: {% endif %}
                      {% if valueLabel %}{{ valueLabel }}{% endif %}
                      
                    {% endif %}
                    {% if hasHeight %}Высота: {{ setPriceVariation.height }} см{% endif %}
                    
                    {% if hasBulbs %}Лампочки: {{ setPriceVariation.bulbsCount }}{% endif %}
              </p>
            </div>
            {% endif %}
            
          {% if not (isInSlider is defined and isInSlider) %}
          <div 
            class="px-2 pb-2 block opacity-0 pointer-events-none transition-opacity duration-200 ease-out group-hover:opacity-100 group-hover:pointer-events-auto absolute inset-x-0 top-full -mt-px z-50 bg-white shadow-xl border-gray-200 border-t-0"
            style="width: 100%;"
            >
          {% if variationsToShow|length > 1 %}
            
              {% for variation in variationsToShow|slice(1) %}
                {% set optionLabel = variation.option is not null ? variation.option.name : null %}
                {% set valueLabel = variation.value is not null ? variation.value.value : null %}
                <div class="leading-4 {% if not loop.first %} mt-2{% endif %}">
                <div class="text-left font-medium text-lg leading-4 {% if not loop.first %} mt-1{% endif %}">
                    {% set hasDiscount = variation.salePrice is not null and variation.price is not null and variation.salePrice < variation.price %}
                    {% if hasDiscount %}
                      <div class="flex items-center gap-2">
                        <span class="line-through text-gray-500 text-sm leading-4">{{ format_price(variation.price)|replace({'₽':'руб.'}) }}</span>
                        <span class="text-red-600 font-medium text-lg leading-4">{{ format_price(variation.salePrice)|replace({'₽':'руб.'}) }}</span>
                      </div>
                    {% else %}
                      {% set basePrice = variation.salePrice is not null ? variation.salePrice : (variation.price ?? null) %}
                      {% if basePrice is not null %}{{ format_price(basePrice)|replace({'₽':'руб.'}) }}{% endif %}
                    {% endif %}
                  </div>
                <div class="flex items-center justify-between text-xs text-gray-700">
                  
                    {% if optionLabel %}{{ optionLabel }}: {% endif %}
                    {% if valueLabel %}{{ valueLabel }}{% endif %}
                  
                  
                    {% if variation.height %}Высота: {{ variation.height }} см{% endif %}
                    
                    {% if variation.bulbsCount %}Лампочки: {{ variation.bulbsCount }}{% endif %}
                  
                  
                </div>
                </div>
              {% endfor %}
            
          {% endif %}
          
          {# Кнопка Купить #}
          <button type="button" 
                  data-product-id="{{ p.id }}"
                  data-module="add-to-cart"
                  data-testid="add-to-cart-grid"
                  class="w-full mt-1 h-10 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-4 rounded-lg shadow-md hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:pointer-events-none disabled:transform-none relative overflow-hidden group">
            <div class="relative flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 transition-transform duration-200 group-hover:scale-110">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
              </svg>
              <span class="text-sm transition-all duration-200 group-hover:tracking-wide">Купить</span>
            </div>
            <div class="loading-spinner absolute inset-0 flex items-center justify-center opacity-0">
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </button>
          </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {# Пагинация #}
    {% set totalPages = (total is defined and limit is defined and limit > 0) ? ((total + limit - 1) // limit) : 1 %}
    {% set loadedCount = products|length %}
    {% set totalCount = total|default(0) %}
    {% set pageSize = limit|default(20) %}
    {% set currentPage = page|default(1) %}
    
    {% if totalPages > 1 %}
      {% set q = app.request.query.all %}
      {% set baseParams = q|merge({ 'limit': limit }) %}
      {# Выбираем маршрут пагинации: поиск или категория #}
      {% set baseRouteName = routeName|default('catalog_category_products') %}
      {% set baseRouteParams = routeParams is defined ? routeParams : (slug is defined ? { 'slug': slug } : {}) %}
      {% if baseParams['page'] is defined %}
        {% set baseParams = baseParams|merge({ 'page': null }) %}
      {% endif %}
      
      {# Кнопка "Показать еще товары" - логика управления в JavaScript #}
      <div class="mt-8 flex items-center justify-center" 
           data-module="load-more"
           data-load-more-container
           data-loaded-count="{{ loadedCount }}"
           data-total-count="{{ totalCount }}"
           data-page-size="{{ pageSize }}"
           data-current-page="{{ currentPage }}">
        {# Индикатор загрузки (скрыт по умолчанию, показывается через JS) #}
        <div class="flex items-center justify-center gap-2 text-gray-600" 
             data-load-more-loader
             style="display: none;">
          <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="text-sm">Загрузка...</span>
        </div>
        
        {# Кнопка "Показать еще товары" (видимость управляется через JS) #}
        <button type="button" 
                class="btn btn-soft"
                data-load-more-button>
          <span class="btn-content">Показать еще товары</span>
          <span class="btn-loader hidden flex items-center justify-center">
            <svg class="animate-spin h-4 w-4 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Загрузка...
          </span>
        </button>
      </div>
      <nav aria-label="Pagination" class="mt-8 pt-8 flex items-center justify-center border-t border-gray-200">
        <div class="flex items-center gap-x-1">
          {% if page > 1 %}
            {% set prevParams = baseParams|merge({ 'page': page - 1 }) %}
            <a class="btn btn-soft max-sm:btn-square" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ prevParams|url_encode }}">
              <span class="icon-[tabler--chevron-left] size-5 rtl:rotate-180"></span>
              <span class="hidden sm:inline">Назад</span>
            </a>
          {% else %}
            <span class="btn btn-soft max-sm:btn-square pointer-events-none opacity-50" aria-disabled="true">
              <span class="icon-[tabler--chevron-left] size-5 rtl:rotate-180"></span>
              <span class="hidden sm:inline">Назад</span>
            </span>
          {% endif %}

          <div class="flex items-center gap-x-1">
            {% for p in 1..totalPages %}
              {% set pParams = baseParams|merge({ 'page': p }) %}
              {% if p == page %}
                <a class="btn btn-soft btn-square aria-[current='page']:text-bg-soft-primary" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ pParams|url_encode }}" aria-current="page">{{ p }}</a>
              {% else %}
                <a class="btn btn-soft btn-square aria-[current='page']:text-bg-soft-primary" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ pParams|url_encode }}">{{ p }}</a>
              {% endif %}
            {% endfor %}
          </div>

          {% if page < totalPages %}
            {% set nextParams = baseParams|merge({ 'page': page + 1 }) %}
            <a class="btn btn-soft max-sm:btn-square" href="{{ path(baseRouteName, baseRouteParams) ~ '?' ~ nextParams|url_encode }}">
              <span class="hidden sm:inline">Вперёд</span>
              <span class="icon-[tabler--chevron-right] size-5 rtl:rotate-180"></span>
            </a>
          {% else %}
            <span class="btn btn-soft max-sm:btn-square pointer-events-none opacity-50" aria-disabled="true">
              <span class="hidden sm:inline">Вперёд</span>
              <span class="icon-[tabler--chevron-right] size-5 rtl:rotate-180"></span>
            </span>
          {% endif %}
        </div>
      </nav>
    {% endif %}
  </div>
</div>




