{% extends 'catalog/base.html.twig' %}

{% block title %}Корзина — {{ parent() }}{% endblock %}

{% block catalog_body %}
{# ai:page=cart map=@page_cart_map.mdc v=1 #}
<div class="container mx-auto px-4 py-6 relative">
  <!-- Spinner для всей корзины -->
  {% include '@App/catalog/components/spinner.html.twig' with {
    id: 'cart-spinner',
    overlay: true,
    size: 'large'
  } %}

  <h1 class="text-2xl font-semibold mb-4">Корзина</h1>

  {% if cart.items|length > 0 %}
    <div class="relative overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="td-cell">Фото</th>
            <th class="td-cell">Товар</th>
            <th class="td-cell">Цена</th>
            <th class="td-cell">Кол-во</th>
            <th class="td-cell">Сумма</th>
            <th class="td-cell"></th>
          </tr>
        </thead>
        <tbody id="cart-items" data-module="cart-items-manager" data-testid="cart-items">
          {% for item in cart.items %}
            <tr class="border-b" data-item-id="{{ item.id }}" data-testid="cart-item">
              <td class="td-cell">
                {% if item.product and item.product.image|length > 0 %}
                  {% set firstImage = item.product.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
                  {% if firstImage %}
                    {% set raw = firstImage.imageUrl %}
                    {% if raw starts with '/media/cache/' %}
                      {% set imgSrc = raw %}
                    {% else %}
                      {% set rel = raw|replace({'/img/':''})|trim('/') %}
                      {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
                    {% endif %}
                    <img src="{{ imgSrc }}" alt="{{ item.productName }}" class="w-16 h-16 object-cover rounded border">
                  {% else %}
                    <div class="placeholder-thumb">
                      Нет фото
                    </div>
                  {% endif %}
                {% else %}
                  <div class="placeholder-thumb">
                    Нет фото
                  </div>
                {% endif %}
              </td>
              <td class="td-cell">
                {% if item.product and item.product.slug %}
                  <a href="{{ path('catalog_product_show', {'slug': item.product.slug}) }}" class="text-blue-600 hover:text-blue-800 hover:underline">
                    {{ item.productName }}
                  </a>
                {% else %}
                  {{ item.productName }}
                {% endif %}

                {# Отображаем выбранные опции товара #}
                {% if item.optionAssignments is defined and item.optionAssignments|length > 0 %}
                  {% set sortedAssignments = item.optionAssignments
                    |sort((a,b) => (a.option.sortOrder <=> b.option.sortOrder) ?: ((a.sortOrder ?? 2147483647) <=> (b.sortOrder ?? 2147483647))) %}
                  <div class="mt-1 text-xs text-gray-600">
                    {% for assignment in sortedAssignments %}
                      <span class="inline-block bg-gray-100 rounded px-2 py-1 mr-1 mb-1">
                        {{ assignment.option.name }}: {{ assignment.value.value }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
              </td>
              <td class="td-cell">
                {# Показываем цену со скидкой и без скидки (Simple/Variable) #}
                {% set discountedPrice = item.effectiveUnitPrice > 0 ? item.effectiveUnitPrice : item.unitPrice %}
                {% set hasOptions = item.optionAssignments is defined and item.optionAssignments|length > 0 %}
                {% set originalPrice = null %}
                {% set hasDiscount = false %}

                {# Вариативный товар: ищем именно ту опцию, чья скидочная цена стала текущей #}
                {% if hasOptions %}
                  {% set matchFound = false %}
                  {% for a in item.optionAssignments %}
                    {% set candidate = a.salePrice is not null ? a.salePrice : (a.price ?? 0) %}
                    {% if not matchFound and candidate == discountedPrice and a.salePrice is not null and a.price is not null and a.salePrice < a.price %}
                      {% set originalPrice = a.price %}
                      {% set hasDiscount = true %}
                      {% set matchFound = true %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {# Простой товар: скидка на самом товаре #}
                  {% if item.product and item.product.salePrice is not null and item.product.price is not null and item.product.salePrice < item.product.price %}
                    {% set originalPrice = item.product.price %}
                    {% set hasDiscount = true %}
                    {% set discountedPrice = item.product.salePrice %}
                  {% endif %}
                {% endif %}

                {% if hasDiscount %}
                  <div class="flex items-center gap-2">
                    <span class="line-through text-gray-500 text-sm">{{ format_price(originalPrice) }}</span>
                    <span class="text-red-600 font-medium">{{ format_price(discountedPrice) }}</span>
                  </div>
                {% else %}
                  {{ format_price(discountedPrice) }}
                {% endif %}
              </td>
              <td class="td-cell">
              <div class="max-w-32" data-input-number>
  <label class="label-text" for="number-input-mini">Quantity:</label>
  <div class="input items-center">
    <button type="button" class="btn btn-primary btn-soft size-5.5 min-h-0 rounded-sm p-0" aria-label="Decrement button" data-input-number-decrement >
      <span class="icon-[tabler--minus] size-3.5 shrink-0"></span>
    </button>
    <input class="text-center" type="text" value="0" aria-label="Mini stacked buttons" data-input-number-input id="number-input-mini" />
    <button type="button" class="btn btn-primary btn-soft size-5.5 min-h-0 rounded-sm p-0" aria-label="Increment button" data-input-number-increment >
      <span class="icon-[tabler--plus] size-3.5 shrink-0"></span>
    </button>
  </div>
</div>
                <input
                  type="number"
                  class="qty-input w-20 border rounded px-2 py-1"
                  value="{{ item.qty }}"
                  min="1"
                  data-item-id="{{ item.id }}"
                  data-testid="qty-input"
                >
              </td>
              <td class="td-cell row-total" data-testid="row-total">{{ format_price(item.rowTotal) }}</td>
              <td class="td-cell">
                <button
                  class="remove text-red-600 hover:underline"
                  data-item-id="{{ item.id }}"
                  data-testid="remove"
                >
                  Удалить
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4" data-module="delivery-methods" data-selected-code="{{ deliveryContext.methodCode|default('') }}">
      <div id="delivery-methods" class="p-4 border rounded" data-testid="delivery-root" data-city-name="{{ deliveryContext.cityName|default('') }}" data-city-id="{{ deliveryContext.cityId|default(0) }}">
        <div class="font-medium mb-2">Способ доставки</div>
        <div id="delivery-methods-list" class="space-y-2">
          {% if types is defined and types is not empty %}
            {% set selectedCode = (deliveryContext.methodCode|default(null)) %}
            {% for t in types %}
              {% set isSelected = (t.code == selectedCode) or (selectedCode is empty and t.default) %}
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="delivery-method" value="{{ t.code }}" {% if isSelected %}checked{% endif %} data-testid="delivery-method-code">
                <span>{{ t.name ?? t.code }}</span>
              </label>
              {% if t.code == 'pvz' %}
                <a href="#"
                   class="text-blue-700 hover:underline text-sm"
                   data-module="modal"
                   data-src="#pvz-map-modal"
                   data-type="inline"
                   data-width="70vw"
                >Показать пункты выдачи на карте</a>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
        <div id="delivery-methods-error" class="text-sm text-red-600 mt-2 hidden"></div>
      </div>
      {# Модальное окно с картой ПВЗ #}
      <div id="pvz-map-modal" class="hidden p-0 w-[70vw] max-w-[90vw] lg:max-w-[70vw]">
        <div class="p-4">
          <h3 class="text-base font-semibold mb-3">Пункты выдачи на карте</h3>
          {% component 'YandexMap' with {
            points: pvzPoints|default([]),
            heightClass: 'h-[520px]',
            showList: false
          } %}{% endcomponent %}
        </div>
      </div>
    </div>

    <div class="mt-4 text-right text-lg">
      {% if delivery.cost is defined and delivery.cost is not null %}
        <div>Стоимость товаров: <span id="cart-subtotal" data-cart-subtotal>{{ cart.subtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        <div>Доставка: <span id="cart-shipping" data-cart-shipping>{{ delivery.cost|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        {% if delivery.term %}
          <div class="text-sm text-gray-600" id="cart-shipping-term" data-cart-shipping-term>{{ delivery.term }}</div>
        {% endif %}
        <div class="border-t pt-2 font-semibold">
          Итого: <span id="cart-total" data-cart-total>{{ (cart.subtotal + delivery.cost)|number_format(0, '.', ' ') ~ ' руб.' }}</span>
        </div>
      {% else %}
        <div>Стоимость товаров: <span id="cart-subtotal" data-cart-subtotal>{{ cart.subtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span></div>
        <div>Доставка: <span id="cart-shipping" data-cart-shipping>Расчет менеджером</span></div>
        <div class="border-t pt-2 font-semibold">
          Итого: <span id="cart-total" data-cart-total>{{ cart.subtotal|number_format(0, '.', ' ') ~ ' руб.' }}</span>
        </div>
      {% endif %}
    </div>

    <script type="module">
      // модуль инициализируется через data-module="delivery-methods"
    </script>

    <div class="mt-6 flex justify-end">
      <a href="{{ path('checkout_page') }}" class="inline-flex items-center px-4 py-2 rounded bg-black text-white hover:bg-gray-900">
        Оформить заказ
      </a>
    </div>
  {% else %}
    <div class="py-12 text-center">
      <div class="text-gray-500 mb-4">Корзина пуста</div>
      <a href="{{ path('catalog_index') }}" class="inline-flex items-center px-4 py-2 rounded bg-black text-white hover:bg-gray-900">
        Перейти к покупкам
      </a>
    </div>
  {% endif %}
</div>


{% endblock %}


