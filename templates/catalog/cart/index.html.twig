{% extends 'catalog/base.html.twig' %}

{% block title %}Корзина — {{ parent() }}{% endblock %}

{% block catalog_body %}
<div class="container mx-auto px-4 py-6 relative">
  <!-- Spinner для всей корзины -->
  {% include 'components/spinner.html.twig' with {
    id: 'cart-spinner',
    overlay: true,
    size: 'large'
  } %}

  <h1 class="text-2xl font-semibold mb-4">Корзина</h1>

  {% if cart.items|length > 0 %}
    <div class="relative overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-4">Фото</th>
            <th class="py-2 pr-4">Товар</th>
            <th class="py-2 pr-4">Цена</th>
            <th class="py-2 pr-4">Кол-во</th>
            <th class="py-2 pr-4">Сумма</th>
            <th class="py-2 pr-4"></th>
          </tr>
        </thead>
        <tbody id="cart-items" data-module="cart-items-manager">
          {% for item in cart.items %}
            <tr class="border-b" data-item-id="{{ item.id }}">
              <td class="py-2 pr-4">
                {% if item.product and item.product.image|length > 0 %}
                  {% set firstImage = item.product.image|sort((a,b) => a.sortOrder <=> b.sortOrder)|first %}
                  {% if firstImage %}
                    {% set raw = firstImage.imageUrl %}
                    {% if raw starts with '/media/cache/' %}
                      {% set imgSrc = raw %}
                    {% else %}
                      {% set rel = raw|replace({'/img/':''})|trim('/') %}
                      {% set imgSrc = asset('/img/' ~ rel) | imagine_filter('md2') %}
                    {% endif %}
                    <img src="{{ imgSrc }}" alt="{{ item.productName }}" class="w-16 h-16 object-cover rounded border">
                  {% else %}
                    <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">
                      Нет фото
                    </div>
                  {% endif %}
                {% else %}
                  <div class="w-16 h-16 bg-gray-200 rounded border flex items-center justify-center text-gray-500 text-xs">
                    Нет фото
                  </div>
                {% endif %}
              </td>
              <td class="py-2 pr-4">
                {% if item.product and item.product.slug %}
                  <a href="{{ path('catalog_product_show', {'slug': item.product.slug}) }}" class="text-blue-600 hover:text-blue-800 hover:underline">
                    {{ item.productName }}
                  </a>
                {% else %}
                  {{ item.productName }}
                {% endif %}

                {# Отображаем выбранные опции товара #}
                {% if item.optionAssignments is defined and item.optionAssignments|length > 0 %}
                  <div class="mt-1 text-xs text-gray-600">
                    {% for assignment in item.optionAssignments %}
                      <span class="inline-block bg-gray-100 rounded px-2 py-1 mr-1 mb-1">
                        {{ assignment.option.name }}: {{ assignment.value.value }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}
              </td>
              <td class="py-2 pr-4">
                {# Используем effectiveUnitPrice, если он больше 0, иначе unitPrice #}
                {% set displayPrice = item.effectiveUnitPrice > 0 ? item.effectiveUnitPrice : item.unitPrice %}
                {{ format_price(displayPrice) }}
              </td>
              <td class="py-2 pr-4">
                <input 
                  type="number" 
                  class="qty-input w-20 border rounded px-2 py-1" 
                  value="{{ item.qty }}" 
                  min="1"
                  data-item-id="{{ item.id }}"
                >
              </td>
              <td class="py-2 pr-4 row-total">{{ format_price(item.rowTotal) }}</td>
              <td class="py-2 pr-4">
                <button 
                  class="remove text-red-600 hover:underline" 
                  data-item-id="{{ item.id }}"
                >
                  Удалить
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 text-right text-lg">
      {% if delivery.cost is defined and delivery.cost is not null %}
        <div>Стоимость товаров: <span id="cart-subtotal" data-cart-subtotal>{{ format_price(cart.subtotal) }}</span> {{ cart.currency }}</div>
        <div>Доставка: <span id="cart-shipping" data-cart-shipping>{{ format_price(delivery.cost) }}</span> {{ cart.currency }}</div>
        {% if delivery.term %}
          <div class="text-sm text-gray-600" id="cart-shipping-term" data-cart-shipping-term>{{ delivery.term }}</div>
        {% endif %}
        <div class="border-t pt-2 font-semibold">
          Итого: <span id="cart-total" data-cart-total>{{ format_price(cart.subtotal + delivery.cost) }}</span> {{ cart.currency }}
        </div>
      {% else %}
        <div>Стоимость товаров: <span id="cart-subtotal" data-cart-subtotal>{{ format_price(cart.subtotal) }}</span> {{ cart.currency }}</div>
        <div>Доставка: <span id="cart-shipping" data-cart-shipping>Расчет менеджером</span></div>
        <div class="border-t pt-2 font-semibold">
          Итого: <span id="cart-total" data-cart-total>{{ format_price(cart.subtotal) }}</span> {{ cart.currency }}
        </div>
      {% endif %}
    </div>

    <div class="mt-6 flex justify-end">
      <a href="{{ path('checkout_page') }}" class="inline-flex items-center px-4 py-2 rounded bg-black text-white hover:bg-gray-900">
        Оформить заказ
      </a>
    </div>
  {% else %}
    <div class="py-12 text-center">
      <div class="text-gray-500 mb-4">Корзина пуста</div>
      <a href="{{ path('catalog_index') }}" class="inline-flex items-center px-4 py-2 rounded bg-black text-white hover:bg-gray-900">
        Перейти к покупкам
      </a>
    </div>
  {% endif %}
</div>


{% endblock %}


