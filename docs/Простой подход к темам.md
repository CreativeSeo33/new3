# Вариант 1: Простые шаблоны (подробно)

## Концепция

Разделяем проект на **2 слоя**:

1. **Core (ядро)** — переиспользуемая бизнес-логика (Entity, Repository, Service, Controller)
2. **Shop (магазин)** — конкретная реализация с уникальными шаблонами и стилями

Каждый магазин — **отдельный Symfony-проект**, который подключает core как composer-пакет.

---

## Структура файлов

```
workspace/
│
├── ecommerce-core/                    # Composer package (ядро)
│   ├── src/
│   │   ├── Entity/
│   │   │   ├── Product.php
│   │   │   ├── Category.php
│   │   │   └── Order.php
│   │   ├── Repository/
│   │   │   ├── ProductRepository.php
│   │   │   └── CategoryRepository.php
│   │   ├── Service/
│   │   │   ├── Cart/
│   │   │   │   ├── CartService.php
│   │   │   │   └── CartCalculator.php
│   │   │   ├── Catalog/
│   │   │   │   ├── ProductSearchService.php
│   │   │   │   └── CategoryTreeBuilder.php
│   │   │   └── Order/
│   │   │       └── OrderProcessor.php
│   │   ├── Controller/
│   │   │   ├── CatalogController.php      # Абстрактный или с дефолтным рендером
│   │   │   ├── ProductController.php
│   │   │   └── CartController.php
│   │   ├── Form/
│   │   │   ├── CheckoutType.php
│   │   │   └── ProductFilterType.php
│   │   └── EventSubscriber/
│   │       └── OrderEventSubscriber.php
│   ├── config/
│   │   └── packages/
│   │       └── core.yaml                   # Дефолтные настройки
│   ├── templates/                          # Базовые шаблоны (опционально)
│   │   └── catalog/
│   │       └── _partials/
│   │           ├── _product_card.html.twig # Переиспользуемые компоненты
│   │           └── _pagination.html.twig
│   ├── composer.json                       # type: library
│   └── README.md
│
├── shop-electronics/                       # Магазин 1 (Symfony app)
│   ├── src/
│   │   └── Controller/                     # Переопределения (если нужны)
│   │       └── HomeController.php          # Кастомный контроллер главной
│   ├── templates/
│   │   ├── base.html.twig                  # Базовый layout магазина
│   │   ├── catalog/
│   │   │   ├── category/
│   │   │   │   └── show.html.twig          # Уникальный дизайн
│   │   │   ├── product/
│   │   │   │   └── show.html.twig
│   │   │   └── layouts/
│   │   │       ├── header.html.twig        # Свой header
│   │   │       └── footer.html.twig
│   │   └── home/
│   │       └── index.html.twig             # Главная страница
│   ├── assets/
│   │   ├── styles/
│   │   │   ├── app.scss                    # Уникальные стили
│   │   │   └── variables.scss              # Цвета магазина
│   │   └── app.ts
│   ├── public/
│   │   └── images/                         # Уникальные изображения
│   │       └── logo-electronics.svg
│   ├── config/
│   │   ├── packages/
│   │   │   └── twig.yaml                   # Переопределения config
│   │   └── services.yaml
│   ├── .env
│   │   DATABASE_URL=mysql://...            # Своя БД
│   │   SHOP_NAME="Electronics Store"
│   ├── composer.json
│   │   require:
│   │     "vendor/ecommerce-core": "^1.0"   # Подключение ядра
│   └── webpack.config.js
│
├── shop-fashion/                           # Магазин 2 (Symfony app)
│   ├── src/
│   ├── templates/                          # Другой дизайн
│   │   ├── base.html.twig
│   │   └── catalog/
│   │       └── product/
│   │           └── show.html.twig          # Совершенно другая верстка
│   ├── assets/
│   │   └── styles/
│   │       └── app.scss                    # Fashion стили (другая палитра)
│   ├── .env
│   │   DATABASE_URL=mysql://...            # Другая БД
│   │   SHOP_NAME="Fashion Boutique"
│   └── composer.json
│       require:
│         "vendor/ecommerce-core": "^1.0"
│
└── shop-books/                             # Магазин 3
    └── ...
```

---

## Пошаговая реализация

### Шаг 1: Создаем Core как Composer Package

```bash
# 1. Создаем директорию core
mkdir ecommerce-core && cd ecommerce-core

# 2. Инициализируем composer
composer init

# Вопросы composer init:
# Package name: yourvendor/ecommerce-core
# Description: E-commerce core business logic
# Type: library
# License: proprietary
# Minimum Stability: dev
```

**composer.json ядра:**

```json
{
    "name": "yourvendor/ecommerce-core",
    "type": "library",
    "description": "E-commerce core business logic",
    "license": "proprietary",
    "autoload": {
        "psr-4": {
            "App\\Core\\": "src/"
        }
    },
    "require": {
        "php": ">=8.1",
        "symfony/framework-bundle": "^6.4",
        "doctrine/orm": "^2.14",
        "doctrine/doctrine-bundle": "^2.10"
    },
    "require-dev": {
        "phpunit/phpunit": "^10.0"
    }
}
```

**Структура ядра:**

```php
// ecommerce-core/src/Entity/Product.php
namespace App\Core\Entity;

use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: ProductRepository::class)]
class Product
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(length: 255)]
    private ?string $name = null;

    #[ORM\Column(type: 'decimal', precision: 10, scale: 2)]
    private ?string $price = null;

    // getters/setters...
}
```

```php
// ecommerce-core/src/Service/Catalog/ProductSearchService.php
namespace App\Core\Service\Catalog;

use App\Core\Repository\ProductRepository;

class ProductSearchService
{
    public function __construct(
        private ProductRepository $productRepository
    ) {}

    public function search(string $query, array $filters = []): array
    {
        // Бизнес-логика поиска
        return $this->productRepository->findBySearchQuery($query, $filters);
    }
}
```

```php
// ecommerce-core/src/Controller/ProductController.php
namespace App\Core\Controller;

use App\Core\Service\Catalog\ProductSearchService;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class ProductController extends AbstractController
{
    public function __construct(
        private ProductSearchService $searchService
    ) {}

    #[Route('/product/{id}', name: 'product_show')]
    public function show(int $id): Response
    {
        $product = $this->searchService->findById($id);
        
        // Рендерим шаблон, который будет переопределен в магазине
        return $this->render('catalog/product/show.html.twig', [
            'product' => $product
        ]);
    }
}
```

**Базовый шаблон в core (опционально):**

```twig
{# ecommerce-core/templates/catalog/product/show.html.twig #}
{# Минималистичный fallback, если магазин не переопределит #}
{% extends 'base.html.twig' %}

{% block content %}
    <h1>{{ product.name }}</h1>
    <p>Price: {{ product.price }}</p>
    <a href="{{ path('cart_add', {id: product.id}) }}">Add to Cart</a>
{% endblock %}
```

---

### Шаг 2: Создаем первый магазин

```bash
# 1. Создаем Symfony проект
composer create-project symfony/skeleton shop-electronics
cd shop-electronics

# 2. Подключаем core локально (для разработки)
composer config repositories.core path ../ecommerce-core
composer require yourvendor/ecommerce-core:@dev

# 3. Устанавливаем дополнительные зависимости
composer require symfony/webpack-encore-bundle
composer require symfony/twig-bundle
npm install
```

**composer.json магазина:**

```json
{
    "name": "yourcompany/shop-electronics",
    "type": "project",
    "require": {
        "php": ">=8.1",
        "symfony/framework-bundle": "^6.4",
        "yourvendor/ecommerce-core": "^1.0",
        "symfony/webpack-encore-bundle": "^2.0"
    },
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        }
    },
    "repositories": [
        {
            "type": "path",
            "url": "../ecommerce-core"
        }
    ]
}
```

---

### Шаг 3: Переопределяем шаблоны в магазине

**Базовый layout магазина:**

```twig
{# shop-electronics/templates/base.html.twig #}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Electronics Store{% endblock %}</title>
    {% block stylesheets %}
        {{ encore_entry_link_tags('app') }}
    {% endblock %}
</head>
<body class="bg-gray-100">
    {% include 'catalog/layouts/header.html.twig' %}
    
    <main class="container mx-auto py-8">
        {% block content %}{% endblock %}
    </main>
    
    {% include 'catalog/layouts/footer.html.twig' %}
    
    {% block javascripts %}
        {{ encore_entry_script_tags('app') }}
    {% endblock %}
</body>
</html>
```

**Уникальный дизайн карточки товара:**

```twig
{# shop-electronics/templates/catalog/product/show.html.twig #}
{% extends 'base.html.twig' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="grid grid-cols-2 gap-8">
        {# Левая колонка - фото #}
        <div class="product-gallery">
            <img src="{{ asset('images/products/' ~ product.image) }}" 
                 alt="{{ product.name }}"
                 class="w-full rounded-lg shadow-lg">
        </div>
        
        {# Правая колонка - инфо #}
        <div class="product-info">
            <h1 class="text-4xl font-bold text-blue-900 mb-4">
                {{ product.name }}
            </h1>
            
            <div class="text-3xl font-semibold text-green-600 mb-6">
                ${{ product.price }}
            </div>
            
            <div class="prose mb-6">
                {{ product.description|raw }}
            </div>
            
            {# Уникальная фича магазина - технические характеристики #}
            <div class="specs bg-blue-50 p-4 rounded mb-6">
                <h3 class="font-semibold mb-2">Specifications</h3>
                <ul class="space-y-1">
                    {% for spec in product.specifications %}
                        <li><strong>{{ spec.name }}:</strong> {{ spec.value }}</li>
                    {% endfor %}
                </ul>
            </div>
            
            <button class="btn-primary w-full" data-product-id="{{ product.id }}">
                Add to Cart
            </button>
        </div>
    </div>
</div>
{% endblock %}
```

**Уникальный header:**

```twig
{# shop-electronics/templates/catalog/layouts/header.html.twig #}
<header class="bg-blue-900 text-white">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <a href="{{ path('home') }}" class="text-2xl font-bold">
                <img src="{{ asset('images/logo-electronics.svg') }}" 
                     alt="Electronics Store" 
                     class="h-12">
            </a>
            
            {# Уникальная навигация для электроники #}
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="{{ path('catalog_category', {slug: 'laptops'}) }}">Laptops</a></li>
                    <li><a href="{{ path('catalog_category', {slug: 'smartphones'}) }}">Smartphones</a></li>
                    <li><a href="{{ path('catalog_category', {slug: 'accessories'}) }}">Accessories</a></li>
                </ul>
            </nav>
            
            <div class="cart-widget">
                <a href="{{ path('cart_index') }}" class="flex items-center">
                    <svg class="w-6 h-6 mr-2"><!-- cart icon --></svg>
                    <span class="cart-count">0</span>
                </a>
            </div>
        </div>
    </div>
</header>
```

---

### Шаг 4: Уникальные стили магазина

```scss
// shop-electronics/assets/styles/app.scss

// Уникальная цветовая схема
$primary-color: #1e3a8a;      // blue-900
$secondary-color: #10b981;    // green-500
$accent-color: #f59e0b;       // amber-500

@import "tailwindcss/base";
@import "tailwindcss/components";
@import "tailwindcss/utilities";

// Уникальные компоненты магазина
.btn-primary {
    @apply bg-blue-900 text-white px-6 py-3 rounded-lg font-semibold;
    @apply hover:bg-blue-800 transition-colors;
}

.product-card {
    @apply bg-white rounded-lg shadow-md p-4;
    @apply hover:shadow-xl transition-shadow;
    
    &__image {
        @apply w-full h-48 object-cover rounded mb-4;
    }
    
    &__title {
        @apply text-lg font-semibold text-blue-900 mb-2;
    }
    
    &__price {
        @apply text-2xl font-bold text-green-600;
    }
}

// Уникальная типографика
h1, h2, h3 {
    font-family: 'Roboto', sans-serif;
    color: $primary-color;
}
```

```javascript
// shop-electronics/assets/app.ts
import './styles/app.scss';

// Уникальная логика магазина
class ElectronicsCart {
    // Специфичная логика для электроники
    // Например, проверка совместимости аксессуаров
    
    checkCompatibility(product: Product, cart: CartItem[]): boolean {
        // ...
    }
}

const cart = new ElectronicsCart();
```

---

### Шаг 5: Переопределение контроллеров (если нужно)

```php
// shop-electronics/src/Controller/HomeController.php
namespace App\Controller;

use App\Core\Service\Catalog\ProductSearchService;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class HomeController extends AbstractController
{
    public function __construct(
        private ProductSearchService $searchService
    ) {}

    #[Route('/', name: 'home')]
    public function index(): Response
    {
        // Уникальная логика главной страницы
        $featuredProducts = $this->searchService->getFeatured(6);
        $bestSellers = $this->searchService->getBestSellers(4);
        
        return $this->render('home/index.html.twig', [
            'featured' => $featuredProducts,
            'bestSellers' => $bestSellers,
        ]);
    }
}
```

```twig
{# shop-electronics/templates/home/index.html.twig #}
{% extends 'base.html.twig' %}

{% block content %}
{# Уникальный дизайн главной для магазина электроники #}
<section class="hero bg-gradient-to-r from-blue-900 to-blue-700 text-white py-20">
    <div class="container mx-auto text-center">
        <h1 class="text-5xl font-bold mb-4">
            Latest Tech at Best Prices
        </h1>
        <p class="text-xl mb-8">
            Free shipping on orders over $100
        </p>
        <a href="{{ path('catalog_index') }}" class="btn-primary">
            Shop Now
        </a>
    </div>
</section>

<section class="py-12">
    <h2 class="text-3xl font-bold mb-8">Featured Products</h2>
    <div class="grid grid-cols-3 gap-6">
        {% for product in featured %}
            {% include 'catalog/product/_card.html.twig' %}
        {% endfor %}
    </div>
</section>
{% endblock %}
```

---

### Шаг 6: Конфигурация магазина

```yaml
# shop-electronics/config/packages/twig.yaml
twig:
    default_path: '%kernel.project_dir%/templates'
    paths:
        # Core templates как fallback
        '%kernel.project_dir%/vendor/yourvendor/ecommerce-core/templates': CoreTemplates
    globals:
        shop_name: '%env(SHOP_NAME)%'
        shop_logo: 'images/logo-electronics.svg'
```

```yaml
# shop-electronics/config/services.yaml
parameters:
    app.upload_directory: '%kernel.project_dir%/public/uploads'
    app.shop_name: 'Electronics Store'

services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Магазин использует все сервисы из core автоматически
    App\:
        resource: '../src/'
        exclude:
            - '../src/Kernel.php'
    
    # Переопределение core-сервиса (если нужно)
    App\Core\Service\Email\EmailService:
        arguments:
            $fromEmail: 'noreply@electronics-store.com'
            $fromName: 'Electronics Store'
```

```env
# shop-electronics/.env
APP_ENV=prod
APP_SECRET=your-secret-key

DATABASE_URL="mysql://user:pass@localhost:3306/shop_electronics"

SHOP_NAME="Electronics Store"
SHOP_DOMAIN="electronics-store.com"

MAILER_DSN=smtp://localhost
```

---

### Шаг 7: Создаем второй магазин (Fashion)

```bash
# Копируем структуру
cp -r shop-electronics shop-fashion
cd shop-fashion

# Меняем composer.json
composer install

# Меняем .env
DATABASE_URL="mysql://user:pass@localhost:3306/shop_fashion"
SHOP_NAME="Fashion Boutique"
```

**Совершенно другой дизайн:**

```twig
{# shop-fashion/templates/catalog/product/show.html.twig #}
{% extends 'base.html.twig' %}

{% block content %}
{# Минималистичный fashion-дизайн #}
<div class="product-showcase">
    <div class="product-image-fullscreen">
        <img src="{{ asset('images/products/' ~ product.image) }}" 
             alt="{{ product.name }}">
    </div>
    
    <div class="product-details-overlay">
        <h1 class="font-serif text-5xl mb-2">{{ product.name }}</h1>
        <p class="text-sm uppercase tracking-widest mb-4">{{ product.brand }}</p>
        <div class="text-2xl mb-6">${{ product.price }}</div>
        
        {# Fashion-специфичные поля #}
        <div class="size-selector mb-4">
            {% for size in product.sizes %}
                <button class="size-option">{{ size }}</button>
            {% endfor %}
        </div>
        
        <button class="btn-fashion">Add to Bag</button>
    </div>
</div>
{% endblock %}
```

```scss
// shop-fashion/assets/styles/app.scss

// Минималистичная палитра
$primary-color: #000000;
$secondary-color: #ffffff;
$accent-color: #c9a96e; // gold

body {
    font-family: 'Playfair Display', serif;
    color: $primary-color;
}

.btn-fashion {
    @apply border-2 border-black px-8 py-3 uppercase tracking-widest;
    @apply hover:bg-black hover:text-white transition-all;
}

.product-showcase {
    display: grid;
    grid-template-columns: 1fr;
    min-height: 100vh;
}

// Минималистичный дизайн
```

---

## Управление версиями Core

### Релизы Core

```bash
cd ecommerce-core

# Создаем tag для стабильной версии
git tag v1.0.0
git push origin v1.0.0
```

**В магазинах указываем версию:**

```json
// shop-electronics/composer.json
{
    "require": {
        "yourvendor/ecommerce-core": "^1.0"  // Любая 1.x.x версия
    }
}
```

### Обновление Core во всех магазинах

```bash
# В каждом магазине
cd shop-electronics
composer update yourvendor/ecommerce-core

cd ../shop-fashion
composer update yourvendor/ecommerce-core
```

---

## Deployment

### Вариант 1: Отдельные серверы

```
Server 1: electronics-store.com
  └── shop-electronics/

Server 2: fashion-boutique.com
  └── shop-fashion/

Server 3: bookshop.com
  └── shop-books/
```

### Вариант 2: Один сервер, разные vhosts

```nginx
# /etc/nginx/sites-available/electronics
server {
    server_name electronics-store.com;
    root /var/www/shop-electronics/public;
    
    location / {
        try_files $uri /index.php$is_args$args;
    }
    
    location ~ ^/index\.php {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        # ...
    }
}

# /etc/nginx/sites-available/fashion
server {
    server_name fashion-boutique.com;
    root /var/www/shop-fashion/public;
    # ...
}
```

### Вариант 3: Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  electronics:
    build: ./shop-electronics
    ports:
      - "8001:80"
    environment:
      - DATABASE_URL=mysql://root:root@db:3306/shop_electronics
    volumes:
      - ./ecommerce-core:/var/www/vendor/yourvendor/ecommerce-core
  
  fashion:
    build: ./shop-fashion
    ports:
      - "8002:80"
    environment:
      - DATABASE_URL=mysql://root:root@db:3306/shop_fashion
    volumes:
      - ./ecommerce-core:/var/www/vendor/yourvendor/ecommerce-core
  
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
```

---

## Плюсы и минусы

### ✅ Преимущества

1. **Полная изоляция**
   - Разные БД
   - Независимые деплои
   - Crash одного магазина не влияет на другие

2. **Простота**
   - Нет runtime-переключений
   - Нет fallback-цепочек
   - Стандартные Twig пути

3. **Гибкость дизайна**
   - Любой дизайн без ограничений
   - Разные CSS frameworks (один Tailwind, другой Bootstrap)
   - Разные JS библиотеки

4. **Масштабируемость**
   - Можно вынести магазины на разные серверы
   - Разные версии PHP/dependencies
   - A/B тесты на уровне целого магазина

5. **Простота разработки**
   - Нет магии
   - Легко дебажить
   - Новый разработчик быстро разберется

### ❌ Недостатки

1. **Дублирование кода**
   - Каждый магазин — полноценный проект
   - Конфиги частично повторяются
   - **Решение:** держать в core максимум логики

2. **Синхронизация изменений**
   - Обновления core нужно накатывать на все магазины
   - **Решение:** автоматизация через CI/CD

3. **Больше репозиториев**
   - Минимум 2 репо (core + магазины)
   - **Решение:** monorepo или git submodules

---

## Автоматизация

### CI/CD для обновлений

```yaml
# .github/workflows/update-core.yml
name: Update Core in All Shops

on:
  push:
    branches:
      - main
    paths:
      - 'ecommerce-core/**'

jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shop: [shop-electronics, shop-fashion, shop-books]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Update ${{ matrix.shop }}
        run: |
          cd ${{ matrix.shop }}
          composer update yourvendor/ecommerce-core
          php bin/phpunit
          
      - name: Deploy ${{ matrix.shop }}
        run: |
          # Deploy script
```

---

## Когда НЕ использовать этот подход

- Магазины должны переключаться в runtime (один домен)
- Нужен маркетплейс тем
- Клиенты сами выбирают дизайн
- Общая БД для всех магазинов

---

## Итого

**Этот подход дает вам:**
- ✅ Простоту обычных Symfony шаблонов
- ✅ Переиспользование кода через composer
- ✅ Полную свободу дизайна для каждого магазина
- ✅ Ноль runtime overhead
- ✅ Легкую поддержку для соло-разработчика

**VS ваша текущая система тем:**
- ❌ 2000+ строк кода системы тем
- ❌ Сложность отладки
- ❌ Риск рекурсий
- ❌ Ограничения fallback-логики