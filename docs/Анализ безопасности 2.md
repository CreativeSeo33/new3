Проверю контроллеры /api/delivery/* для CSRF/методов и inline-скрипта, чтобы точно назвать уязвимость. Затем просмотрю глобальные CORS настройки.

[15 tools called]

Коротко: основные фиксы прошли, но есть ещё риски/дырки.

Что ещё осталось:

- CSRF в Delivery API (POST):
  - `POST /api/delivery/select-city`, `select-method`, `select-pvz` не проверяют CSRF‑токен. Клиент присылает `X-CSRF-Token` глобально, но контроллеры его не валидируют.
  - Риск: CSRF‑изменение контекста доставки и стоимости.
  - Исправление: в каждом POST‑методе проверить заголовок:
    - Добавить аргумент `CsrfTokenManagerInterface $csrf`, доставать `X-CSRF-Token`, `isTokenValid(new CsrfToken('api', $token))`, иначе 419.

- Слабая обязательность предикатов записи в Delivery API:
  - Есть `CartWriteGuard`, но `requirePrecondition = false` (совместимый режим). Клиент не всегда шлёт `If-Match`/`version` (например, в `selectCity` из `city-modal` заголовок не обязателен).
  - Риск: гонки/перезапись состояния корзины из параллельных вкладок.
  - Исправление: включить строгий режим для write‑эндпойнтов корзины/доставки (DI параметр `requirePrecondition=true`) либо хотя бы для `DeliveryApiController`.

- Инъекции/валидация входа:
  - `CheckoutController::submit`:
    - `email` валидируется, но отсутствуют ограничения по длине `name`, `comment`, возможны очень длинные строки.
    - Риск: раздувание БД/логов, попытки XSS через отображение комментария (проверить где выводится).
    - Исправление: ограничить длины (`mb_strlen <= 255` для name/email/phone, comment <= 1000), нормализовать телефон, почистить невидимые символы.
  - `DeliveryApiController::selectMethod` принимает `address` без лимита; позднее обрезается до 255 при записи в `OrderDelivery`, но раньше хранится в сессии — ок, но лучше ранний лимит/trim.

- Публичные Delivery endpoints:
  - `DeliveryPublicController` — только GET, CORS настроен, пагинация ограничена, кэш есть. Ок.
  - Но проверь, чтобы не утекали приватные поля сущностей — используется кастомный QB/мэппинг, безопасно.

- CSP и inline‑скрипты:
  - В `templates/catalog/delivery/index.html.twig` есть inline `<script>` (старый блок). CSP не проверяли; при строгом CSP это сломается. По правилам проекта inline‑скрипты запрещены.
  - Риск: XSS‑поверхность и несоблюдение архитектуры.
  - Исправление: вынести скрипт в FSD‑модуль (feature/widget) и инициализировать через `data-module`.

- Сессия и SameSite:
  - `framework.yaml`: `cookie_samesite: 'lax'`, `cookie_httponly: true`, `cookie_secure: 'auto'` — адекватно. Оставить.

- Маскирование ошибок:
  - HTTP‑клиент возвращает текст ошибки сервера целиком в `Error('HTTP <status>: <body>')`. Возможна утечка стеков/сообщений в alert. Уже в UI выбрали общий fallback — ок.

- PII:
  - Перевели на `sessionStorage`. Ок. Дополнительно: можно не кэшировать email вовсе, по требованиям.

- Несогласованность форматов:
  - Выправили «руб.». В JS `delivery-selector` теперь тоже выводит « руб.». Ок.

Предлагаемые точечные правки (минимально инвазивно):

1) CSRF‑проверка в Delivery API POST
- В `src/Controller/Api/DeliveryApiController.php` в методах `selectCity`, `selectMethod`, `selectPvz`:
  - Добавить аргумент `CsrfTokenManagerInterface $csrf` и в начале:
    - ` $token = (string)$r->headers->get('X-CSRF-Token', '');`
    - ` if ($token === '' || !$csrf->isTokenValid(new CsrfToken('api', $token))) return new JsonResponse(['error'=>'invalid_csrf'], 419);`

2) Ограничения входных данных
- В `CheckoutController::submit`:
  - После извлечения полей:
    - отрезать длины: `if (mb_strlen($name) > 255 || mb_strlen($phone) > 64 || mb_strlen($email) > 255 || mb_strlen($comment) > 1000) return $this->json(['error'=>'payload too long'], 400);`
  - Нормализовать телефон (минимально — оставить цифры и +, проверить длину 7..20).
- В `DeliveryApiController::selectMethod`:
  - `address = mb_substr($address, 0, 255);`

3) Убрать inline‑скрипт со страницы `templates/catalog/delivery/index.html.twig`
- Вынести блок `<script>(function(){...})()</script>` в модуль `features/delivery-page-select` и инициализировать через `data-module`.
- Если нужно, сделаю отдельным коммитом; это нетривиальная переноска, но быстрая.

Скажешь — внедрю CSRF в Delivery API и ограничения длин сразу.