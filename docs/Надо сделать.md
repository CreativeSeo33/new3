# Надо сделать

В админке, когда нажимаем копировать товар, товар копируется, но товары не обновляются. надо сделать обновление списка товаров после успешного копирования.

Когда удаляем фото товара в админке, не надо удалять фото из кеша, потому что оно пропадает у другого товара, если фото добавлено к другому товару.

На странице /checkout/success проверить правильность показа цены доставки, цена 780, а вижу Расчет менеджером.

- [x] На странице поиска добавить блок Выбранные фильтры (SSR + UI), аналогично странице категории.


- [ ] Включить JWT для `/api/admin/**` при деплое на PROD

## Упрощение работы с городом (по названию вместо ID/FIAS)

Варианты перехода — выбрать один и выполнить чек‑лист.

- [ ] Вариант 1 (минимальный): публичные эндпоинты только по названию
  - [ ] В `src/Controller/Api/DeliveryPublicController.php` убрать поддержку `cityId`; фильтрацию и кеш‑ключ строить только по `city` (строка)
  - [ ] В `src/Controller/Api/DeliveryApiController.php` (если используется публичная выдача ПВЗ) убрать ветки с `IDENTITY(p.cityFias)`; фильтровать по `LOWER(TRIM(p.city)) = :city`
  - [ ] Привести `src/Service/GeoIpService.php` к возврату только `{ cityName }` (без `cityId`)
  - [ ] Поиск по коду: удалить/игнорировать использование `cityId` в публичных контроллерах и фронте витрины
  - [ ] Админ‑часть и сущность `Fias` оставить без изменений (используется для справочников), конфликтов с витриной быть не должно

- [ ] Вариант 2 (полный отказ от FIAS в витрине и данных доставки)
  - [ ] В `src/Entity/PvzPoints.php` и `src/Entity/PvzPrice.php` убрать поле/связь `cityFias` (FK на `fias`), работать только со строковым `city`
  - [ ] Миграции БД: удалить FK `city_id` из таблиц ПВЗ/тарифов, убедиться в наличии индекса по нормализованному `city` (LOWER(TRIM(city)))
  - [ ] Обновить контроллеры: везде перейти на фильтр по названию города и кеш по `city`
  - [ ] Удалить/архивировать `FiasService` и `FiasRepository`; сущность `Fias` и связанные эндпоинты — удалить, если в админке не требуется
  - [ ] Фронт (витрина): удалить использование `cityId`/`cityKladr` из API вызовов; оставить `cityName`
  - [ ] Фронт (Admin SPA): привести DTO/репозитории `PvzPointsRepository`/`PvzPriceRepository` к использованию `city` вместо `cityId`
  - [ ] Миграция данных: при необходимости перенести названия городов из FIAS в строковое поле `city` в ПВЗ/тарифах
  - [ ] Обновить документацию API (параметры `cityId` — удалить), smoke‑тест публичных эндпоинтов

## Инструкция для агента (включение JWT на PROD)

1) Включить отдельный firewall для админского API

```yaml
# config/packages/security.yaml
security:
  firewalls:
    admin_api:
      pattern: ^/api/admin
      stateless: true
      provider: app_user_provider
      jwt: ~
```

2) Запретить публичный доступ к `/api/admin/**`

```yaml
# config/packages/security.yaml
security:
  access_control:
    - { path: ^/api/admin, roles: ROLE_ADMIN }
    - { path: ^/api, roles: PUBLIC_ACCESS }
    - { path: ^/login$, roles: PUBLIC_ACCESS }
    - { path: ^/admin, roles: ROLE_ADMIN }
```

3) Проверить конфигурацию JWT (LexikJWT)

```yaml
# config/packages/lexik_jwt_authentication.yaml
lexik_jwt_authentication:
  secret_key: '%env(string:JWT_SECRET)%'
  token_ttl: 604800
  encoder:
    signature_algorithm: HS256
```

4) Установить секрет JWT на PROD
- Секрет не коммитить в репозиторий. Установить через переменные окружения/секреты деплой-платформы.
- Генерация секрета (32 байта):

```bash
php -r "echo bin2hex(random_bytes(32));"
```

- Примеры установки:
  - Linux (systemd/ENV): экспортируйте `JWT_SECRET` в окружение процесса PHP-FPM / веб-сервера
  - Symfony `.env.local` (на сервере):

```bash
echo JWT_SECRET=<СЮДА_СЕКРЕТ> >> .env.local
```

5) Сбросить кэш и перезапустить сервисы

```bash
php bin/console cache:clear --env=prod
php bin/console cache:warmup --env=prod
# перезапуск php-fpm/nginx по окружению
```

6) Проверка

```bash
# 1) Получить токен (замените креды администратора)
curl -k -s -X POST https://<host>/api/login \
  -H 'Content-Type: application/json' \
  -d '{"name":"admin","password":"<password>"}'
# => { "token": "<JWT>" }

# 2) Обращение к админскому API с токеном
curl -k -s https://<host>/api/admin/products/1/form \
  -H "Authorization: Bearer <JWT>"
```

7) SPA (Admin)
- В `assets/admin/services/http.ts` заголовок `Authorization` подставляется автоматически из `localStorage.getItem('token')`.
- На проде убедиться, что flow логина (POST `/api/login`) сохраняет `token` в `localStorage`.

8) План отката (dev/аварийно)
- Временно открыть админский API:
  - Удалить/закомментировать firewall `admin_api` или
  - В `access_control` поставить: `{ path: ^/api/admin, roles: PUBLIC_ACCESS }`.
- После устранения причин вернуть конфигурацию из п.1-2.

## Замечания по безопасности
- Не хранить `JWT_SECRET` в VCS. Использовать ENV/секреты CI/CD.
- При смене `JWT_SECRET` все ранее выданные токены станут недействительными — потребуется перелогиниться.
- Следить, чтобы `/api/**` вне `/api/admin/**` оставался публичным только там, где это бизнес‑требование.
