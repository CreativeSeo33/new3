# Надо сделать

- [ ] Включить JWT для `/api/admin/**` при деплое на PROD

## Инструкция для агента (включение JWT на PROD)

1) Включить отдельный firewall для админского API

```yaml
# config/packages/security.yaml
security:
  firewalls:
    admin_api:
      pattern: ^/api/admin
      stateless: true
      provider: app_user_provider
      jwt: ~
```

2) Запретить публичный доступ к `/api/admin/**`

```yaml
# config/packages/security.yaml
security:
  access_control:
    - { path: ^/api/admin, roles: ROLE_ADMIN }
    - { path: ^/api, roles: PUBLIC_ACCESS }
    - { path: ^/login$, roles: PUBLIC_ACCESS }
    - { path: ^/admin, roles: ROLE_ADMIN }
```

3) Проверить конфигурацию JWT (LexikJWT)

```yaml
# config/packages/lexik_jwt_authentication.yaml
lexik_jwt_authentication:
  secret_key: '%env(string:JWT_SECRET)%'
  token_ttl: 604800
  encoder:
    signature_algorithm: HS256
```

4) Установить секрет JWT на PROD
- Секрет не коммитить в репозиторий. Установить через переменные окружения/секреты деплой-платформы.
- Генерация секрета (32 байта):

```bash
php -r "echo bin2hex(random_bytes(32));"
```

- Примеры установки:
  - Linux (systemd/ENV): экспортируйте `JWT_SECRET` в окружение процесса PHP-FPM / веб-сервера
  - Symfony `.env.local` (на сервере):

```bash
echo JWT_SECRET=<СЮДА_СЕКРЕТ> >> .env.local
```

5) Сбросить кэш и перезапустить сервисы

```bash
php bin/console cache:clear --env=prod
php bin/console cache:warmup --env=prod
# перезапуск php-fpm/nginx по окружению
```

6) Проверка

```bash
# 1) Получить токен (замените креды администратора)
curl -k -s -X POST https://<host>/api/login \
  -H 'Content-Type: application/json' \
  -d '{"name":"admin","password":"<password>"}'
# => { "token": "<JWT>" }

# 2) Обращение к админскому API с токеном
curl -k -s https://<host>/api/admin/products/1/form \
  -H "Authorization: Bearer <JWT>"
```

7) SPA (Admin)
- В `assets/admin/services/http.ts` заголовок `Authorization` подставляется автоматически из `localStorage.getItem('token')`.
- На проде убедиться, что flow логина (POST `/api/login`) сохраняет `token` в `localStorage`.

8) План отката (dev/аварийно)
- Временно открыть админский API:
  - Удалить/закомментировать firewall `admin_api` или
  - В `access_control` поставить: `{ path: ^/api/admin, roles: PUBLIC_ACCESS }`.
- После устранения причин вернуть конфигурацию из п.1-2.

## Замечания по безопасности
- Не хранить `JWT_SECRET` в VCS. Использовать ENV/секреты CI/CD.
- При смене `JWT_SECRET` все ранее выданные токены станут недействительными — потребуется перелогиниться.
- Следить, чтобы `/api/**` вне `/api/admin/**` оставался публичным только там, где это бизнес‑требование.
